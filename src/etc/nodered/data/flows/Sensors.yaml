- id: ec75ad2cb670e9c0
  type: tab
  label: Sensors
  disabled: false
  info: ''
  env: []
- id: 9695703c2344fa5a
  type: junction
  z: ec75ad2cb670e9c0
  x: 1130
  'y': 320
  wires:
    - - dcc503f036cd122b
- id: 48cdf1ba85dfcd37
  type: serial in
  z: ec75ad2cb670e9c0
  name: CurrentCost
  serial: 2389cf8558b3742d
  x: 110
  'y': 140
  wires:
    - - 44401c61545f8b54
- id: 44401c61545f8b54
  type: xml
  z: ec75ad2cb670e9c0
  name: xml2json
  property: payload
  attr: ''
  chr: ''
  x: 210
  'y': 220
  wires:
    - - bbc11ee1b53a74b6
- id: 7894147300ba4e35
  type: mqtt out
  z: ec75ad2cb670e9c0
  name: sensors/xxx/nodes/...
  topic: ''
  qos: ''
  retain: ''
  broker: c38452a5.4f84e8
  x: 1010
  'y': 190
  wires: []
- id: 9b9aa3979144f9f4
  type: catch
  z: ec75ad2cb670e9c0
  name: ''
  scope: null
  uncaught: false
  x: 100
  'y': 60
  wires:
    - - b38faeed3daa5034
- id: b38faeed3daa5034
  type: link out
  z: ec75ad2cb670e9c0
  name: General CatchAll
  links:
    - 1bf42829.b3e0b8
  x: 255
  'y': 60
  wires: []
- id: d6e08f42e4a188de
  type: debug
  z: ec75ad2cb670e9c0
  name: CCDebug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 820
  'y': 260
  wires: []
- id: 0e9eb4e190902bd8
  type: function
  z: ec75ad2cb670e9c0
  name: power-inst
  func: |-
    var msgres1 =  {
        payload: {
            payload: [
                { "value": Number(msg.payload.value) },
                { "type": "power-inst", "location": msg.payload.name }
            ],
            measurement: "sensors"
        }
    }

    var msgres2 = {
        payload: {
            payload: [
                { "ccost_PAPP": Number(msg.payload.value) },
                { "location": msg.payload.name }
            ],
            measurement: "sensors"
        }
    }

    return [
        msgres1,
        msgres2
    ]
  outputs: 2
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 1000
  'y': 300
  wires:
    - - 9695703c2344fa5a
    - - 9695703c2344fa5a
      - 4575d700fd60f480
- id: aae3f5fc1bf84067
  type: switch
  z: ec75ad2cb670e9c0
  name: ''
  property: payload.type
  propertyType: msg
  rules:
    - t: eq
      v: watts
      vt: str
    - t: eq
      v: temperature
      vt: str
    - t: else
  checkall: 'true'
  repair: false
  outputs: 3
  x: 820
  'y': 310
  wires:
    - - 0e9eb4e190902bd8
    - - 03f4e78666d3f120
    - - 88197bac85a955f3
- id: 6fb898c071ee2fdd
  type: function
  z: ec75ad2cb670e9c0
  name: Friendly name
  func: |-
    var tidhome = global.get("tidhome") || {}
    sensors = tidhome.sensors || {}
    currsnetcostNodes = sensors.currentcost.nodes || {}

    let i = 0;
    let len = currsnetcostNodes.length;
    for (; i < len; ) {
      if(currsnetcostNodes[i].id === msg.payload.id) {
        msg.payload.name = "cc-" + msg.payload.id + "-" + currsnetcostNodes[i].location || "Unknown"
      }
      i++;
    } 

    // pass through
    return msg;
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 620
  'y': 280
  wires:
    - - d6e08f42e4a188de
      - aae3f5fc1bf84067
- id: 88197bac85a955f3
  type: debug
  z: ec75ad2cb670e9c0
  name: CCDebug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 990
  'y': 380
  wires: []
- id: 03f4e78666d3f120
  type: function
  z: ec75ad2cb670e9c0
  name: temperature
  func: |
    var msgres1 =  {
        payload: {
            payload: [
                { "value": Number(msg.payload.value) },
                { "type": "temperature", "location": "cc-Bureau" }
            ],
            measurement: "sensors"
        }
    }

    var msgres2 = {
        payload: {
            payload: [
                { "ccost_temperature": Number(msg.payload.value) },
                { "location": "cc-Bureau" }
            ],
            measurement: "sensors"
        }
    }

    return [
        msgres1,
        msgres2
    ]
  outputs: 2
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 1000
  'y': 340
  wires:
    - - 9695703c2344fa5a
    - - 9695703c2344fa5a
- id: bbc11ee1b53a74b6
  type: switch
  z: ec75ad2cb670e9c0
  name: ''
  property: 'payload.msg.type[0]'
  propertyType: msg
  rules:
    - t: eq
      v: '1'
      vt: str
    - t: eq
      v: '2'
      vt: str
    - t: else
  checkall: 'true'
  repair: false
  outputs: 3
  x: 340
  'y': 180
  wires:
    - - e018d12e8cad5fbf
    - - 77da59c25f261bfc
    - - 77da59c25f261bfc
- id: 77da59c25f261bfc
  type: debug
  z: ec75ad2cb670e9c0
  name: CCDebug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 490
  'y': 200
  wires: []
- id: e018d12e8cad5fbf
  type: function
  z: ec75ad2cb670e9c0
  name: 'sensor Type, "1" = electricity'
  func: >-
    // name: Parse CurrentCost

    // outputs: 1

    var outputMsgs = []

    var timestampH = new Date().toISOString()

    var timestamp = new Date().getTime()


    // temperature

    if(msg.payload.msg.tmpr != undefined && msg.payload.msg.sensor[0] == '1') {
        // sensors/iotpower/nodes/1/entries/1/events/temperature
        let type = 'temperature'
        let nodeid = 1 // Bureau
        let entry = 1
        let value = msg.payload.msg.tmpr[0]
        
        let msgT = {}
        msgT.topic = 'sensors/iotpower/nodes/' + nodeid + '/entries/' + entry + '/events/' + type;
        msgT.payload = { 
            "gateway":"iotpower",
            "id": nodeid,
            "entry": entry,
            "type": type,
            "value": parseFloat(value),
            "timestamp": timestamp,
            "timestamp-human": timestampH
        }
        let displayMsg = msgT.payload.id + "/" + msgT.payload.type + "=" + msgT.payload.value
        node.status({ fill:"orange", shape:"dot", text: displayMsg });
        outputMsgs.push(msgT);
        // node.warn("CC event temp:\n" + JSON.stringify(msgT))
    }


    // Live power

    if(msg.payload.msg.sensor != undefined && msg.payload.msg.sensor[0] !=
    undefined) {
        // sensors/iotpower/nodes/.../entries/0/events/watts
        let type = 'watts'
        let nodeid = parseInt(msg.payload.msg.sensor[0])
        let entry = 0
        let value = msg.payload.msg.ch1[0].watts[0]
        
        let msgP = {}
        msgP.topic = 'sensors/iotpower/nodes/' + nodeid + '/entries/' + entry + '/events/' + type;
        msgP.payload = { 
            "gateway":"iotpower",
            "id": nodeid,
            "entry": entry,
            "type": type,
            "value": parseFloat(value),
            "timestamp": timestamp,
            "timestamp-human": timestampH
        }
        let displayMsg = msgP.payload.id + " => " + msgP.payload.value + " " + msgP.payload.type
        node.status({ fill:"blue", shape:"dot", text: displayMsg });
        outputMsgs.push(msgP);
        // node.warn("CC event:\n" + JSON.stringify(msg))
    }


    /*

    // History power

    for (var i in msg.payload.msg.hist[0].data) {
        var chunk = msg.payload.msg.hist[0].data[i];
        var chunkClean = {};
        for (var j in chunk) {
            chunkClean[j] = chunk[j][0];
        }
        var topic = 'sensors/03967/entries/' + chunk.sensor[0] + '/history/power';
        outputMsgs.push( { topic:topic, payload: chunkClean });
    }

    */


    return [ outputMsgs ];
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 550
  'y': 140
  wires:
    - - 7894147300ba4e35
      - 6fb898c071ee2fdd
      - 2b3793d257e19809
- id: 2b3793d257e19809
  type: debug
  z: ec75ad2cb670e9c0
  name: CC W Debug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 980
  'y': 140
  wires: []
- id: dcc503f036cd122b
  type: link out
  z: ec75ad2cb670e9c0
  name: link out 3
  mode: link
  links:
    - 8f74f3f76c223f4d
  x: 1175
  'y': 320
  wires: []
- id: 4575d700fd60f480
  type: debug
  z: ec75ad2cb670e9c0
  name: CCDebug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 1220
  'y': 260
  wires: []
- id: a8cd2888c83eb4f6
  type: serial in
  z: ec75ad2cb670e9c0
  name: Jeelink
  serial: aa3008f8a002170a
  x: 90
  'y': 480
  wires:
    - - e324eb60e5e0fd71
- id: 82feacacfc9ee30f
  type: mqtt out
  z: ec75ad2cb670e9c0
  name: sensors/xxx/nodes/...
  topic: ''
  qos: ''
  retain: ''
  broker: c38452a5.4f84e8
  x: 760
  'y': 480
  wires: []
- id: 03653501b09f1ff3
  type: debug
  z: ec75ad2cb670e9c0
  name: Debug
  active: false
  tosidebar: true
  console: true
  tostatus: false
  complete: 'true'
  targetType: full
  x: 1140
  'y': 550
  wires: []
- id: 51b1bc3751c94bf7
  type: function
  z: ec75ad2cb670e9c0
  name: query insert
  func: >-
    var msgres =  {
        payload: {
            payload: [
                { "value": Number(msg.payload.value) },
                { "type": msg.payload.type, "location": msg.topic }
            ],
            measurement: "sensors"
        }
    }


    node.status({ fill: "blue", shape: "dot", text: msg.topic + ": " +
    Number(msg.payload.value) });


    return msgres;
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 930
  'y': 570
  wires:
    - - 62a23415b0a2245c
      - 03653501b09f1ff3
- id: 62a23415b0a2245c
  type: mqtt out
  z: ec75ad2cb670e9c0
  name: sensors
  topic: sensors
  qos: ''
  retain: ''
  broker: c38452a5.4f84e8
  x: 1140
  'y': 590
  wires: []
- id: 518d9a7198e9a4c9
  type: switch
  z: ec75ad2cb670e9c0
  name: Sort
  property: payload.type
  propertyType: msg
  rules:
    - t: eq
      v: temperature
      vt: str
    - t: eq
      v: humidity
      vt: str
    - t: eq
      v: pressure
      vt: str
    - t: else
  checkall: 'true'
  repair: false
  outputs: 4
  x: 710
  'y': 580
  wires:
    - - 51b1bc3751c94bf7
    - - 51b1bc3751c94bf7
    - - 51b1bc3751c94bf7
    - - 65f1413068738793
- id: 65f1413068738793
  type: debug
  z: ec75ad2cb670e9c0
  name: Not looked
  active: false
  tosidebar: true
  console: true
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 930
  'y': 630
  wires: []
- id: e324eb60e5e0fd71
  type: function
  z: ec75ad2cb670e9c0
  name: Parse JeeLink
  func: |-
    // name: Parse JeeLink
    // outputs: 1
    var outputMsgs = []
    timestampH = new Date().toISOString()
    timestamp = new Date().getTime()

    var s = msg.payload.split(' ')
    if(s[0] === 'ROOM') {
        var type = ''
        var nodeid = parseInt(s[1])
        // var nodeid5 = ("00000" + nodeid).slice (-5)
        var entry = parseInt(s[2])
        var value = s[4].replace(/(\r\n|\n|\r)/gm,"");
        if(s[3] == 0) {
          type = 'temperature';
          value = value / 10;
        } else if(s[3] == 1) {
          type = 'humidity';
          value = value / 10;
        } else if(s[3] == 2) {
          type = 'pressure';
          value = value / 10;
        } else if(s[3] == 3) {
          type = 'light';
        } else if(s[3] == 4 && value !== 0) {
          type = 'battery';
          value = value / 100;
        } else if(s[3] == 5) {
          type = 'soil';
        } else if(s[3] == 6) {
          type = 'toggle';
          value = parseInt(value);
        }
        
        if(type !== '') {
            var msgJ = {}
            msgJ.topic = 'sensors/rfm868usb/nodes/' + nodeid + '/entries/' + entry + '/events/' + type;
            msgJ.payload = { 
                "gateway":"rfm868usb",
                "id": nodeid,
                "entry": entry,
                "type": type,
                "value": value,
                "timestamp": timestamp,
                "timestamp-human": timestampH
            }
            node.status({ fill:"blue", shape:"dot", text: msg.payload });
            outputMsgs.push(msgJ);
        } else {
          node.status({ fill:"red", shape:"dot", text: msg.payload });
        }
        
        //setTimeout(function() { this.status({}); }, 500);
        //this.status({fill:"green",shape:"dot",text:"processed"});
    }

    return [ outputMsgs ];
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 320
  'y': 480
  wires:
    - - 518d9a7198e9a4c9
      - 82feacacfc9ee30f
      - c28fe8ce0758bb68
- id: c28fe8ce0758bb68
  type: trigger
  z: ec75ad2cb670e9c0
  name: Watchdog
  op1: ''
  op2: ''
  op1type: nul
  op2type: pay
  duration: '1'
  extend: true
  overrideDelay: false
  units: hr
  reset: ''
  bytopic: topic
  topic: topic
  outputs: 1
  x: 520
  'y': 650
  wires:
    - - d10281f1d98eed79
- id: d10281f1d98eed79
  type: debug
  z: ec75ad2cb670e9c0
  name: JL W Debug
  active: true
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 730
  'y': 650
  wires: []
