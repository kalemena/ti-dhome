- id: ec75ad2cb670e9c0
  type: tab
  label: Sensors
  disabled: false
  info: ''
  env: []
- id: 9695703c2344fa5a
  type: junction
  z: ec75ad2cb670e9c0
  x: 1130
  'y': 320
  wires:
    - - dcc503f036cd122b
- id: 4f3f06d7be8ae294
  type: junction
  z: ec75ad2cb670e9c0
  x: 1110
  'y': 1260
  wires:
    - - deee902d14d9f69f
      - edacb98cc2cf3239
- id: 3a926826af10884b
  type: junction
  z: ec75ad2cb670e9c0
  x: 1370
  'y': 1440
  wires:
    - - a8ad9ac1058063da
      - edacb98cc2cf3239
- id: 214a7a3538c0f9d7
  type: junction
  z: ec75ad2cb670e9c0
  x: 880
  'y': 1490
  wires:
    - - 19075162ee42791e
      - 02b328556dfff5f1
- id: e20462ad11c24a6e
  type: junction
  z: ec75ad2cb670e9c0
  x: 1050
  'y': 1600
  wires:
    - - 2824712821b59f6c
      - d07cbbeeea4b6838
- id: 928dbbeb61728ae8
  type: junction
  z: ec75ad2cb670e9c0
  x: 270
  'y': 1930
  wires:
    - - 7a7da9f99dc91f57
      - fecc50545bb0eadb
- id: aede2387acfabe40
  type: junction
  z: ec75ad2cb670e9c0
  x: 1050
  'y': 1950
  wires:
    - - ae9f3e3b816d1937
      - 837d2234bda1d724
- id: 24518d39f0d7f3e8
  type: junction
  z: ec75ad2cb670e9c0
  x: 800
  'y': 1980
  wires:
    - - ff92d9f85eeda30e
      - 17d6f5a85077df47
- id: 5c8e03f5abcc6c4f
  type: junction
  z: ec75ad2cb670e9c0
  x: 600
  'y': 2220
  wires:
    - - 0cd9d34b9af9cb74
      - 5cc60cc5361ef586
- id: f4669f975aff8c94
  type: junction
  z: ec75ad2cb670e9c0
  x: 900
  'y': 2690
  wires:
    - - d81ddfcbb68c35af
- id: e0f4def5f27a20d1
  type: junction
  z: ec75ad2cb670e9c0
  x: 920
  'y': 2180
  wires:
    - - f12c2500fc578913
- id: f1612c0ae6828f97
  type: junction
  z: ec75ad2cb670e9c0
  x: 920
  'y': 2220
  wires:
    - - b09f11acafb9618a
- id: 48cdf1ba85dfcd37
  type: serial in
  z: ec75ad2cb670e9c0
  name: CurrentCost
  serial: 2389cf8558b3742d
  x: 110
  'y': 140
  wires:
    - - 44401c61545f8b54
- id: 44401c61545f8b54
  type: xml
  z: ec75ad2cb670e9c0
  name: xml2json
  property: payload
  attr: ''
  chr: ''
  x: 210
  'y': 220
  wires:
    - - bbc11ee1b53a74b6
- id: 7894147300ba4e35
  type: mqtt out
  z: ec75ad2cb670e9c0
  name: sensors/xxx/nodes/...
  topic: ''
  qos: ''
  retain: ''
  broker: c38452a5.4f84e8
  x: 1010
  'y': 190
  wires: []
- id: 9b9aa3979144f9f4
  type: catch
  z: ec75ad2cb670e9c0
  name: ''
  scope: null
  uncaught: false
  x: 100
  'y': 60
  wires:
    - - b38faeed3daa5034
- id: b38faeed3daa5034
  type: link out
  z: ec75ad2cb670e9c0
  name: General CatchAll
  links:
    - 1bf42829.b3e0b8
  x: 255
  'y': 60
  wires: []
- id: d6e08f42e4a188de
  type: debug
  z: ec75ad2cb670e9c0
  name: CCDebug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 820
  'y': 260
  wires: []
- id: 0e9eb4e190902bd8
  type: function
  z: ec75ad2cb670e9c0
  name: power-inst
  func: |-
    var msgres1 =  {
        payload: {
            payload: [
                { "value": Number(msg.payload.value) },
                { "type": "power-inst", "location": msg.payload.name }
            ],
            measurement: "sensors"
        }
    }

    var msgres2 = {
        payload: {
            payload: [
                { "ccost_PAPP": Number(msg.payload.value) },
                { "location": msg.payload.name }
            ],
            measurement: "sensors"
        }
    }

    return [
        msgres1,
        msgres2
    ]
  outputs: 2
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 1000
  'y': 300
  wires:
    - - 9695703c2344fa5a
    - - 9695703c2344fa5a
      - 4575d700fd60f480
- id: aae3f5fc1bf84067
  type: switch
  z: ec75ad2cb670e9c0
  name: ''
  property: payload.type
  propertyType: msg
  rules:
    - t: eq
      v: watts
      vt: str
    - t: eq
      v: temperature
      vt: str
    - t: else
  checkall: 'true'
  repair: false
  outputs: 3
  x: 820
  'y': 310
  wires:
    - - 0e9eb4e190902bd8
    - - 03f4e78666d3f120
    - - 88197bac85a955f3
- id: 6fb898c071ee2fdd
  type: function
  z: ec75ad2cb670e9c0
  name: Friendly name
  func: |-
    var tidhome = global.get("tidhome") || {}
    sensors = tidhome.sensors || {}
    currsnetcostNodes = sensors.currentcost.nodes || {}

    let i = 0;
    let len = currsnetcostNodes.length;
    for (; i < len; ) {
      if(currsnetcostNodes[i].id === msg.payload.id) {
        msg.payload.name = "cc-" + msg.payload.id + "-" + currsnetcostNodes[i].location || "Unknown"
      }
      i++;
    } 

    // pass through
    return msg;
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 620
  'y': 280
  wires:
    - - d6e08f42e4a188de
      - aae3f5fc1bf84067
- id: 88197bac85a955f3
  type: debug
  z: ec75ad2cb670e9c0
  name: CCDebug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 990
  'y': 380
  wires: []
- id: 03f4e78666d3f120
  type: function
  z: ec75ad2cb670e9c0
  name: temperature
  func: |
    var msgres1 =  {
        payload: {
            payload: [
                { "value": Number(msg.payload.value) },
                { "type": "temperature", "location": "cc-Bureau" }
            ],
            measurement: "sensors"
        }
    }

    var msgres2 = {
        payload: {
            payload: [
                { "ccost_temperature": Number(msg.payload.value) },
                { "location": "cc-Bureau" }
            ],
            measurement: "sensors"
        }
    }

    return [
        msgres1,
        msgres2
    ]
  outputs: 2
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 1000
  'y': 340
  wires:
    - - 9695703c2344fa5a
    - - 9695703c2344fa5a
- id: bbc11ee1b53a74b6
  type: switch
  z: ec75ad2cb670e9c0
  name: ''
  property: 'payload.msg.type[0]'
  propertyType: msg
  rules:
    - t: eq
      v: '1'
      vt: str
    - t: eq
      v: '2'
      vt: str
    - t: else
  checkall: 'true'
  repair: false
  outputs: 3
  x: 340
  'y': 180
  wires:
    - - e018d12e8cad5fbf
    - - 77da59c25f261bfc
    - - 77da59c25f261bfc
- id: 77da59c25f261bfc
  type: debug
  z: ec75ad2cb670e9c0
  name: CCDebug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 490
  'y': 200
  wires: []
- id: e018d12e8cad5fbf
  type: function
  z: ec75ad2cb670e9c0
  name: 'sensor Type, "1" = electricity'
  func: >-
    // name: Parse CurrentCost

    // outputs: 1

    var outputMsgs = []

    var timestampH = new Date().toISOString()

    var timestamp = new Date().getTime()


    // temperature

    if(msg.payload.msg.tmpr != undefined && msg.payload.msg.sensor[0] == '1') {
        // sensors/iotpower/nodes/1/entries/1/events/temperature
        let type = 'temperature'
        let nodeid = 1 // Bureau
        let entry = 1
        let value = msg.payload.msg.tmpr[0]
        
        let msgT = {}
        msgT.topic = 'sensors/iotpower/nodes/' + nodeid + '/entries/' + entry + '/events/' + type;
        msgT.payload = { 
            "gateway":"iotpower",
            "id": nodeid,
            "entry": entry,
            "type": type,
            "value": parseFloat(value),
            "timestamp": timestamp,
            "timestamp-human": timestampH
        }
        let displayMsg = msgT.payload.id + "/" + msgT.payload.type + "=" + msgT.payload.value
        node.status({ fill:"orange", shape:"dot", text: displayMsg });
        outputMsgs.push(msgT);
        // node.warn("CC event temp:\n" + JSON.stringify(msgT))
    }


    // Live power

    if(msg.payload.msg.sensor != undefined && msg.payload.msg.sensor[0] !=
    undefined) {
        // sensors/iotpower/nodes/.../entries/0/events/watts
        let type = 'watts'
        let nodeid = parseInt(msg.payload.msg.sensor[0])
        let entry = 0
        let value = msg.payload.msg.ch1[0].watts[0]
        
        let msgP = {}
        msgP.topic = 'sensors/iotpower/nodes/' + nodeid + '/entries/' + entry + '/events/' + type;
        msgP.payload = { 
            "gateway":"iotpower",
            "id": nodeid,
            "entry": entry,
            "type": type,
            "value": parseFloat(value),
            "timestamp": timestamp,
            "timestamp-human": timestampH
        }
        let displayMsg = msgP.payload.id + " => " + msgP.payload.value + " " + msgP.payload.type
        node.status({ fill:"blue", shape:"dot", text: displayMsg });
        outputMsgs.push(msgP);
        // node.warn("CC event:\n" + JSON.stringify(msg))
    }


    /*

    // History power

    for (var i in msg.payload.msg.hist[0].data) {
        var chunk = msg.payload.msg.hist[0].data[i];
        var chunkClean = {};
        for (var j in chunk) {
            chunkClean[j] = chunk[j][0];
        }
        var topic = 'sensors/03967/entries/' + chunk.sensor[0] + '/history/power';
        outputMsgs.push( { topic:topic, payload: chunkClean });
    }

    */


    return [ outputMsgs ];
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 550
  'y': 140
  wires:
    - - 7894147300ba4e35
      - 6fb898c071ee2fdd
      - 2b3793d257e19809
- id: 2b3793d257e19809
  type: debug
  z: ec75ad2cb670e9c0
  name: CC W Debug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 980
  'y': 140
  wires: []
- id: dcc503f036cd122b
  type: link out
  z: ec75ad2cb670e9c0
  name: link out 3
  mode: link
  links:
    - 8f74f3f76c223f4d
  x: 1175
  'y': 320
  wires: []
- id: 4575d700fd60f480
  type: debug
  z: ec75ad2cb670e9c0
  name: CCDebug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 1220
  'y': 260
  wires: []
- id: a8cd2888c83eb4f6
  type: serial in
  z: ec75ad2cb670e9c0
  name: Jeelink
  serial: aa3008f8a002170a
  x: 90
  'y': 480
  wires:
    - - e324eb60e5e0fd71
- id: 82feacacfc9ee30f
  type: mqtt out
  z: ec75ad2cb670e9c0
  name: sensors/xxx/nodes/...
  topic: ''
  qos: ''
  retain: ''
  broker: c38452a5.4f84e8
  x: 760
  'y': 480
  wires: []
- id: 03653501b09f1ff3
  type: debug
  z: ec75ad2cb670e9c0
  name: Debug
  active: false
  tosidebar: true
  console: true
  tostatus: false
  complete: 'true'
  targetType: full
  x: 1140
  'y': 550
  wires: []
- id: 51b1bc3751c94bf7
  type: function
  z: ec75ad2cb670e9c0
  name: query insert
  func: >-
    var msgres =  {
        payload: {
            payload: [
                { "value": Number(msg.payload.value) },
                { "type": msg.payload.type, "location": msg.topic }
            ],
            measurement: "sensors"
        }
    }


    node.status({ fill: "blue", shape: "dot", text: msg.topic + ": " +
    Number(msg.payload.value) });


    return msgres;
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 930
  'y': 570
  wires:
    - - 62a23415b0a2245c
      - 03653501b09f1ff3
- id: 62a23415b0a2245c
  type: mqtt out
  z: ec75ad2cb670e9c0
  name: sensors
  topic: sensors
  qos: ''
  retain: ''
  broker: c38452a5.4f84e8
  x: 1140
  'y': 590
  wires: []
- id: 518d9a7198e9a4c9
  type: switch
  z: ec75ad2cb670e9c0
  name: Sort
  property: payload.type
  propertyType: msg
  rules:
    - t: eq
      v: temperature
      vt: str
    - t: eq
      v: humidity
      vt: str
    - t: eq
      v: pressure
      vt: str
    - t: else
  checkall: 'true'
  repair: false
  outputs: 4
  x: 710
  'y': 580
  wires:
    - - 51b1bc3751c94bf7
    - - 51b1bc3751c94bf7
    - - 51b1bc3751c94bf7
    - - 65f1413068738793
- id: 65f1413068738793
  type: debug
  z: ec75ad2cb670e9c0
  name: Not looked
  active: false
  tosidebar: true
  console: true
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 930
  'y': 630
  wires: []
- id: e324eb60e5e0fd71
  type: function
  z: ec75ad2cb670e9c0
  name: Parse JeeLink
  func: |-
    // name: Parse JeeLink
    // outputs: 1
    var outputMsgs = []
    timestampH = new Date().toISOString()
    timestamp = new Date().getTime()

    var s = msg.payload.split(' ')
    if(s[0] === 'ROOM') {
        var type = ''
        var nodeid = parseInt(s[1])
        // var nodeid5 = ("00000" + nodeid).slice (-5)
        var entry = parseInt(s[2])
        var value = s[4].replace(/(\r\n|\n|\r)/gm,"");
        if(s[3] == 0) {
          type = 'temperature';
          value = value / 10;
        } else if(s[3] == 1) {
          type = 'humidity';
          value = value / 10;
        } else if(s[3] == 2) {
          type = 'pressure';
          value = value / 10;
        } else if(s[3] == 3) {
          type = 'light';
        } else if(s[3] == 4 && value !== 0) {
          type = 'battery';
          value = value / 100;
        } else if(s[3] == 5) {
          type = 'soil';
        } else if(s[3] == 6) {
          type = 'toggle';
          value = parseInt(value);
        }
        
        if(type !== '') {
            var msgJ = {}
            msgJ.topic = 'sensors/rfm868usb/nodes/' + nodeid + '/entries/' + entry + '/events/' + type;
            msgJ.payload = { 
                "gateway":"rfm868usb",
                "id": nodeid,
                "entry": entry,
                "type": type,
                "value": value,
                "timestamp": timestamp,
                "timestamp-human": timestampH
            }
            node.status({ fill:"blue", shape:"dot", text: msg.payload });
            outputMsgs.push(msgJ);
        } else {
          node.status({ fill:"red", shape:"dot", text: msg.payload });
        }
        
        //setTimeout(function() { this.status({}); }, 500);
        //this.status({fill:"green",shape:"dot",text:"processed"});
    }

    return [ outputMsgs ];
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 320
  'y': 480
  wires:
    - - 518d9a7198e9a4c9
      - 82feacacfc9ee30f
      - c28fe8ce0758bb68
- id: c28fe8ce0758bb68
  type: trigger
  z: ec75ad2cb670e9c0
  name: Watchdog
  op1: ''
  op2: ''
  op1type: nul
  op2type: pay
  duration: '1'
  extend: true
  overrideDelay: false
  units: hr
  reset: ''
  bytopic: topic
  topic: topic
  outputs: 1
  x: 520
  'y': 650
  wires:
    - - d10281f1d98eed79
- id: d10281f1d98eed79
  type: debug
  z: ec75ad2cb670e9c0
  name: JL W Debug
  active: true
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 730
  'y': 650
  wires: []
- id: c794716e926bc4f8
  type: http request
  z: ec75ad2cb670e9c0
  name: Web Relays
  method: GET
  ret: obj
  paytoqs: ignore
  url: 'http://ioteleinfo.local/status'
  tls: ''
  persist: true
  proxy: ''
  insecureHTTPParser: false
  authType: ''
  senderr: false
  headers: []
  x: 350
  'y': 820
  wires:
    - - 845f7fc20572b666
      - 77617e95c29eac68
- id: 6b4bb63d1b2c2cdf
  type: inject
  z: ec75ad2cb670e9c0
  name: Poll Web Relays (60s)
  repeat: '60'
  crontab: ''
  once: false
  onceDelay: ''
  topic: ''
  payload: ''
  payloadType: str
  x: 140
  'y': 820
  wires:
    - - c794716e926bc4f8
- id: 292908d51b5eef4f
  type: mqtt out
  z: ec75ad2cb670e9c0
  name: sensors/xxx/nodes/...
  topic: ''
  qos: ''
  retain: ''
  broker: c38452a5.4f84e8
  x: 780
  'y': 810
  wires: []
- id: 845f7fc20572b666
  type: debug
  z: ec75ad2cb670e9c0
  name: WR-Debug-Poll
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: payload
  targetType: msg
  statusVal: ''
  statusType: auto
  x: 540
  'y': 870
  wires: []
- id: 718f2cc1589da67f
  type: comment
  z: ec75ad2cb670e9c0
  name: Actors - MQTT push
  info: ''
  x: 120
  'y': 900
  wires: []
- id: cb0786eff7515a2a
  type: mqtt in
  z: ec75ad2cb670e9c0
  name: actors/iotheaters/switch
  topic: actors/iotheaters/switch
  qos: '2'
  datatype: json
  broker: c38452a5.4f84e8
  inputs: 0
  x: 130
  'y': 940
  wires:
    - - d2fe7bae3ec14024
- id: d2fe7bae3ec14024
  type: http request
  z: ec75ad2cb670e9c0
  name: Switch Web Relays
  method: GET
  ret: txt
  paytoqs: ignore
  url: 'http://ioteleinfo.local/relays/set?id={{{payload.id}}}&value=-1'
  tls: ''
  persist: false
  proxy: ''
  insecureHTTPParser: false
  authType: ''
  senderr: false
  headers: []
  x: 560
  'y': 940
  wires:
    - - 2c7df083710cb173
- id: 2c7df083710cb173
  type: debug
  z: ec75ad2cb670e9c0
  name: ''
  active: false
  console: 'false'
  complete: 'true'
  x: 790
  'y': 940
  wires: []
- id: 0ddd9271bf3c418f
  type: websocket in
  z: ec75ad2cb670e9c0
  name: WebRelay
  server: ''
  client: 7e89f6fe472270aa
  x: 90
  'y': 1110
  wires:
    - - 18f9bc805dacd963
      - 36e1445c396adeef
      - 7b7272b3f4dadcb7
      - 30f2aae70f48250d
- id: b43f2b600593f743
  type: switch
  z: ec75ad2cb670e9c0
  name: sensors value
  property: sensors
  propertyType: msg
  rules:
    - t: hask
      v: temperature
      vt: str
    - t: hask
      v: humidity
      vt: str
    - t: else
  checkall: 'true'
  repair: false
  outputs: 3
  x: 660
  'y': 1240
  wires:
    - - 9c35edae7a98631b
    - - 8b7eebac2a610c4f
    - []
- id: 9c35edae7a98631b
  type: function
  z: ec75ad2cb670e9c0
  name: Sensors-Temperature
  func: |-
    var msgres =  {
        payload: {
            topic: "teleinfo-temperature-wr-Garage",
            payload: [
                { "value": Number(msg.sensors.temperature) },
                { "type": "temperature", "location": "wr-Garage" }
            ],
            measurement: "sensors"
        }
    }

    return msgres;
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 940
  'y': 1240
  wires:
    - - 4f3f06d7be8ae294
- id: 8b7eebac2a610c4f
  type: function
  z: ec75ad2cb670e9c0
  name: Sensors-Humidity
  func: |-
    var msgres =  {
        payload: {
            topic: "teleinfo-humidity-wr-Garage",
            payload: [
                { "value": Number(msg.sensors.humidity) },
                { "type": "humidity", "location": "wr-Garage" }
            ],
            measurement: "sensors"
        }
    }

    return msgres;
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 930
  'y': 1280
  wires:
    - - 4f3f06d7be8ae294
- id: 18f9bc805dacd963
  type: debug
  z: ec75ad2cb670e9c0
  name: WR Debug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 270
  'y': 1070
  wires: []
- id: bcf38e1a8e3a46a4
  type: debug
  z: ec75ad2cb670e9c0
  name: WR-SensorsDebug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 670
  'y': 1290
  wires: []
- id: 36e1445c396adeef
  type: switch
  z: ec75ad2cb670e9c0
  name: relays
  property: relays
  propertyType: msg
  rules:
    - t: nnull
  checkall: 'true'
  repair: false
  outputs: 1
  x: 250
  'y': 1110
  wires:
    - - 3590f1c1c74c32e7
- id: f653a97136699a7b
  type: function
  z: ec75ad2cb670e9c0
  name: Relays-OnOff
  func: |-
    var msgres =  {
        payload: {
            payload: [
                { "value": Number(msg.payload.value) },
                { "type": "plug-onoff", "location": "wr-Garage-" + msg.payload.id }
            ],
            measurement: "sensors"
        }
    }

    return msgres;
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 980
  'y': 1110
  wires:
    - - edacb98cc2cf3239
- id: 81a50e6af370e5f6
  type: debug
  z: ec75ad2cb670e9c0
  name: WR-RelaysDebug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 670
  'y': 1150
  wires: []
- id: 7b7272b3f4dadcb7
  type: switch
  z: ec75ad2cb670e9c0
  name: sensors
  property: sensors
  propertyType: msg
  rules:
    - t: nnull
  checkall: 'true'
  repair: false
  outputs: 1
  x: 260
  'y': 1150
  wires:
    - - 126b55a125fd205c
- id: 30f2aae70f48250d
  type: switch
  z: ec75ad2cb670e9c0
  name: teleinfo
  property: teleinfo
  propertyType: msg
  rules:
    - t: nnull
  checkall: 'true'
  repair: false
  outputs: 1
  x: 260
  'y': 1190
  wires:
    - - 8cdaa772fd602d38
- id: 8d698cc848f2a78a
  type: split
  z: ec75ad2cb670e9c0
  name: ''
  splt: \n
  spltType: str
  arraySplt: 1
  arraySpltType: len
  stream: false
  addname: ''
  x: 820
  'y': 1110
  wires:
    - - f653a97136699a7b
- id: 4f9db8945ed3ad9c
  type: change
  z: ec75ad2cb670e9c0
  name: keys
  rules:
    - t: set
      p: payload
      pt: msg
      to: relays
      tot: msg
      dc: true
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 630
  'y': 1110
  wires:
    - - 8d698cc848f2a78a
- id: 9feec7cce5e484f7
  type: debug
  z: ec75ad2cb670e9c0
  name: WR-TeleinfoDebug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 670
  'y': 1440
  wires: []
- id: a8ad9ac1058063da
  type: debug
  z: ec75ad2cb670e9c0
  name: StorageDebug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 1490
  'y': 1430
  wires: []
- id: 40224e0c1b893541
  type: mqtt in
  z: ec75ad2cb670e9c0
  name: actors/iotheaters/set
  topic: actors/iotheaters/set
  qos: '2'
  datatype: json
  broker: c38452a5.4f84e8
  nl: false
  rap: false
  inputs: 0
  x: 120
  'y': 990
  wires:
    - - 0f563e7c046d1d73
- id: c44483f4706eadf2
  type: debug
  z: ec75ad2cb670e9c0
  name: ''
  active: false
  console: 'false'
  complete: 'true'
  x: 790
  'y': 990
  wires: []
- id: 433fe1856e26da1f
  type: http request
  z: ec75ad2cb670e9c0
  name: Set Web Relays
  method: GET
  ret: txt
  paytoqs: ignore
  url: >-
    http://ioteleinfo.local/relays/set?id={{{payload.id}}}&state={{{payload.value}}}
  tls: ''
  persist: false
  proxy: ''
  insecureHTTPParser: false
  authType: ''
  senderr: false
  headers: []
  x: 550
  'y': 990
  wires:
    - - c44483f4706eadf2
- id: 0f563e7c046d1d73
  type: delay
  z: ec75ad2cb670e9c0
  name: ''
  pauseType: rate
  timeout: '500'
  timeoutUnits: milliseconds
  rate: '1'
  nbRateUnits: '0.1'
  rateUnits: second
  randomFirst: '1'
  randomLast: '5'
  randomUnits: seconds
  drop: false
  allowrate: false
  outputs: 1
  x: 340
  'y': 990
  wires:
    - - 433fe1856e26da1f
- id: 77617e95c29eac68
  type: function
  z: ec75ad2cb670e9c0
  name: Parse WebRelays
  func: |-
    // name: Parse web relays
    // outputs: 1
    var outputMsgs = []
    var displayMsg = ""
    var timestampH = new Date().toISOString()
    var timestamp = new Date().getTime()

    for (var i in msg.payload.relays) {
        
        let relayId = msg.payload.relays[i].id
        let relayDesc = msg.payload.relays[i].description
        let relayValue = msg.payload.relays[i].value
        let type = 'toggle'
        let entry = 0
        
        var msgS = {}
        msgS.topic = 'sensors/iotheaters/nodes/' + relayId + '/entries/' + entry + '/events/' + type;
        msgS.payload = { 
            "gateway":"iotheaters",
            "id": relayId,
            "entry": entry,
            "type": type,
            "value": relayValue,
            "timestamp": timestamp,
            "timestamp-human": timestampH
        }
        displayMsg += relayDesc + "(" + relayId + ")=" + relayValue + "; "
        outputMsgs.push(msgS);
    }

    node.status({ fill:"blue", shape:"dot", text: displayMsg });

    return [ outputMsgs ];
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 550
  'y': 810
  wires:
    - - 292908d51b5eef4f
- id: deee902d14d9f69f
  type: debug
  z: ec75ad2cb670e9c0
  name: WR W Debug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 1290
  'y': 1260
  wires: []
- id: 993cf64deccadfaf
  type: split
  z: ec75ad2cb670e9c0
  name: ''
  splt: \n
  spltType: str
  arraySplt: 1
  arraySpltType: len
  stream: false
  addname: topic
  x: 760
  'y': 1400
  wires:
    - - d863057a25ab0896
      - be29ee5cf7174c69
- id: 4464a01f3af22ec2
  type: change
  z: ec75ad2cb670e9c0
  name: keys
  rules:
    - t: set
      p: payload
      pt: msg
      to: teleinfo
      tot: msg
      dc: true
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 630
  'y': 1400
  wires:
    - - 993cf64deccadfaf
- id: c25c5c35d9536f04
  type: link in
  z: ec75ad2cb670e9c0
  name: In-WS-Teleinfo
  links:
    - 8cdaa772fd602d38
  x: 535
  'y': 1400
  wires:
    - - 4464a01f3af22ec2
      - 9feec7cce5e484f7
- id: d87094764684cc41
  type: comment
  z: ec75ad2cb670e9c0
  name: Teleinfo Events
  info: ''
  x: 600
  'y': 1350
  wires: []
- id: 8cdaa772fd602d38
  type: link out
  z: ec75ad2cb670e9c0
  name: Out-WS-Teleinfo
  mode: link
  links:
    - c25c5c35d9536f04
  x: 415
  'y': 1190
  wires: []
- id: 0fb3e71c0ce56c0a
  type: switch
  z: ec75ad2cb670e9c0
  name: ''
  property: topic
  propertyType: msg
  rules:
    - t: cont
      v: BBRH
      vt: str
    - t: else
  checkall: 'false'
  repair: false
  outputs: 2
  x: 770
  'y': 1500
  wires:
    - - 214a7a3538c0f9d7
      - e20462ad11c24a6e
    - - e20462ad11c24a6e
- id: 62cbf3d2735867d5
  type: function
  z: ec75ad2cb670e9c0
  name: Insert X
  func: >-
    // sensors_value

    let fields = { "value": Number(msg.payload) }

    let tags =   { "type": "teleinfo-" + msg.topic, "location": "main" }


    var msgres1 =  {
        topic: "teleinfo-" + msg.topic,
        payload: {
            payload: [ fields, tags ],
            measurement: "sensors"
        }
    }


    // sensors_teleinfo_X

    let namedFieldName = "teleinfo_" + msg.topic

    let namedFields = { [namedFieldName]: Number(msg.payload) }

    var namedTags = { "location": "main" }


    var msgres2 = {
        topic: namedFieldName,
        payload: {
            payload: [namedFields, namedTags],
            measurement: "sensors"
        }
    }


    // live info

    node.status({ fill: "blue", shape: "dot", text: msg.topic + ": " +
    Number(msg.payload) });


    return [
        msgres1,
        msgres2
    ]
  outputs: 2
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 1280
  'y': 1620
  wires:
    - - 3a926826af10884b
    - - 3a926826af10884b
- id: 2824712821b59f6c
  type: function
  z: ec75ad2cb670e9c0
  name: IsNumeric
  func: |
    function isNumeric(n) { 
        return !isNaN(parseFloat(n)) && isFinite(n); 
    }

    // convert to numeric if possible
    if (isNumeric(msg.payload)) {
        node.status({ fill: "blue", shape: "dot", text: msg.topic + ": " + Number(msg.payload) });
        return { topic: msg.topic, payload: Number(msg.payload) }
    }
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 1140
  'y': 1620
  wires:
    - - 62cbf3d2735867d5
- id: 1d3b3214dcde0243
  type: comment
  z: ec75ad2cb670e9c0
  name: Sensors Events
  info: ''
  x: 600
  'y': 1190
  wires: []
- id: da439ed30df38b5b
  type: link in
  z: ec75ad2cb670e9c0
  name: In-WS-Sensors
  links:
    - 126b55a125fd205c
  x: 535
  'y': 1230
  wires:
    - - bcf38e1a8e3a46a4
      - b43f2b600593f743
- id: 126b55a125fd205c
  type: link out
  z: ec75ad2cb670e9c0
  name: Out-WS-Sensors
  mode: link
  links:
    - da439ed30df38b5b
  x: 415
  'y': 1150
  wires: []
- id: 30127bf3c7b49cde
  type: comment
  z: ec75ad2cb670e9c0
  name: Sensors Relays
  info: ''
  x: 600
  'y': 1070
  wires: []
- id: a0c7d1d54f89df2f
  type: link in
  z: ec75ad2cb670e9c0
  name: In-WS-Relays
  links:
    - 3590f1c1c74c32e7
  x: 535
  'y': 1110
  wires:
    - - 4f9db8945ed3ad9c
      - 81a50e6af370e5f6
- id: 3590f1c1c74c32e7
  type: link out
  z: ec75ad2cb670e9c0
  name: Out-WS-Relays
  mode: link
  links:
    - a0c7d1d54f89df2f
  x: 415
  'y': 1110
  wires: []
- id: d863057a25ab0896
  type: function
  z: ec75ad2cb670e9c0
  name: Global
  func: |-
    function isNumeric(n) {
        return !isNaN(parseFloat(n)) && isFinite(n);
    }

    // convert to numeric if possible
    if (isNumeric(msg.payload)) {
        msg.payload = Number(msg.payload)
    }

    global.set("tidhome_teleinfo." + msg.topic, msg.payload)
    return { topic: msg.topic, payload: msg.payload }
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 890
  'y': 1400
  wires:
    - - 0fb3e71c0ce56c0a
- id: edacb98cc2cf3239
  type: link out
  z: ec75ad2cb670e9c0
  name: link out 2
  mode: link
  links:
    - 8f74f3f76c223f4d
  x: 1435
  'y': 1130
  wires: []
- id: 19075162ee42791e
  type: function
  z: ec75ad2cb670e9c0
  name: Indexes Wh
  func: |-
    var periods = [
        "BBRHPJB",
        "BBRHCJB",
        "BBRHPJW",
        "BBRHCJW",
        "BBRHPJR",
        "BBRHCJR"
    ]

    let text = ""
    let teleinfoTotal = 0
    let fields = {}

    for(var period in periods) {
        // get index from memory
        let idxPeriod = Number(global.get("tidhome_teleinfo." + periods[period]))
        
        switch (periods[period]) {
            case "BBRHPJB":
                if (idxPeriod > 0) { 
                    // set DB index for an update
                    fields["teleinfo_" + periods[period]] = idxPeriod

                    fields["teleinfo_HCHP"] = idxPeriod
                }
                break
            case "BBRHCJB":
                if (idxPeriod > 0) { 
                    // set DB index for an update
                    fields["teleinfo_" + periods[period]] = idxPeriod

                    fields["teleinfo_HCHC"] = idxPeriod
                }
                break
            default:
                // set DB index for an update
                fields["teleinfo_" + periods[period]] = idxPeriod
                break
        }

        // compute total
        teleinfoTotal += idxPeriod
        // message for debug
        text += ((text.length > 0) ? " / " : "") + periods[period].substring(3) + ': ' + idxPeriod
    }

    // Index fields
    fields["teleinfo_Wh_Total"] = Number(teleinfoTotal)    

    let tags =   { "location": "main" }

    var msg =  {
        topic: "teleinfo",
        payload: {
            payload: [ fields, tags ],
            measurement: "sensors"
        }
    }

    node.status({ fill: "blue", shape: "dot", text: text });

    return msg
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 1000
  'y': 1470
  wires:
    - - e26a2cc5cb07a613
- id: d07cbbeeea4b6838
  type: debug
  z: ec75ad2cb670e9c0
  name: WR-Teleinfo-Periods-Debug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 1200
  'y': 1580
  wires: []
- id: 02b328556dfff5f1
  type: function
  z: ec75ad2cb670e9c0
  name: int(PTEC)
  func: |-
    // update period as integer (1=HPJB, 2=HCJB, 3=HPJW, ...)
    let period = -1
    let topic = 'PTEC_int'
    if(msg.topic.startsWith('BBR')) {
        switch(msg.topic) {
            case 'BBRHPJB':
                period = 1
                break
            case 'BBRHCJB':
                period = 2
                break
            case 'BBRHPJW':
                period = 3
                break
            case 'BBRHCJW':
                period = 4
                break
            case 'BBRHPJR':
                period = 5
                break
            case 'BBRHCJR':
                period = 6
                break
        }

        if(period > 0) {
            global.set("tidhome_teleinfo." + topic, Number(period))

            return {
                topic: topic,
                payload: period
            }
        }
    }
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 990
  'y': 1520
  wires:
    - - e20462ad11c24a6e
- id: e26a2cc5cb07a613
  type: delay
  z: ec75ad2cb670e9c0
  name: 1 msg/m
  pauseType: timed
  timeout: '5'
  timeoutUnits: seconds
  rate: '1'
  nbRateUnits: '1'
  rateUnits: minute
  randomFirst: '1'
  randomLast: '5'
  randomUnits: seconds
  drop: true
  allowrate: false
  outputs: 1
  x: 1220
  'y': 1440
  wires:
    - - 3a926826af10884b
- id: be29ee5cf7174c69
  type: debug
  z: ec75ad2cb670e9c0
  name: WR-TeleinfoDebug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 930
  'y': 1360
  wires: []
- id: 20d4c9c4e7aa7f75
  type: comment
  z: ec75ad2cb670e9c0
  name: ZigBee Events
  info: ''
  x: 140
  'y': 1800
  wires: []
- id: 10fdb4f725ec2b0f
  type: mqtt in
  z: ec75ad2cb670e9c0
  name: ''
  topic: zigbee2mqtt/bridge/logging
  qos: '2'
  datatype: json
  broker: c38452a5.4f84e8
  nl: false
  rap: true
  rh: 0
  inputs: 0
  x: 200
  'y': 1840
  wires:
    - - b358dfcd704f6110
- id: b358dfcd704f6110
  type: debug
  z: ec75ad2cb670e9c0
  name: ZDebug-All
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 420
  'y': 1840
  wires: []
- id: bace985d48876ed3
  type: mqtt in
  z: ec75ad2cb670e9c0
  name: ''
  topic: zigbee2mqtt/+
  qos: '2'
  datatype: json
  broker: c38452a5.4f84e8
  nl: false
  rap: true
  rh: 0
  inputs: 0
  x: 160
  'y': 1930
  wires:
    - - 928dbbeb61728ae8
- id: 7a7da9f99dc91f57
  type: debug
  z: ec75ad2cb670e9c0
  name: ZDebugEvent
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 400
  'y': 1910
  wires: []
- id: fecc50545bb0eadb
  type: function
  z: ec75ad2cb670e9c0
  name: Name?
  func: |-
    msg.sensor_name = msg.topic.replace("zigbee2mqtt/","")
    return msg
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 380
  'y': 1950
  wires:
    - - dc80044db3ef479c
- id: dc80044db3ef479c
  type: split
  z: ec75ad2cb670e9c0
  name: ''
  splt: \n
  spltType: str
  arraySplt: 1
  arraySpltType: len
  stream: false
  addname: topic
  x: 530
  'y': 1950
  wires:
    - - 31367ce045ab32a2
- id: 0ab48e38c7515cbf
  type: function
  z: ec75ad2cb670e9c0
  name: Store Global
  func: |-
    var uniqueName = "tidhome_zigbee." + msg.sensor_name + "." + msg.topic
    msg.unique_name = uniqueName
    global.set(uniqueName, msg.payload)
    global.set("tidhome_zigbee." + msg.sensor_name + ".ts", Date.now())
    return msg
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 550
  'y': 1990
  wires:
    - - ec4ab99b1e9b03d7
      - 164bfa497952db59
- id: ff92d9f85eeda30e
  type: function
  z: ec75ad2cb670e9c0
  name: sensors_value
  func: >-
    let fields = { "value": Number(msg.payload) }

    let tags = { "type": "zigbee-" + msg.topic, "location": msg.sensor_name }


    var msgres = {
        topic: "zigbee-" + msg.topic,
        payload: {
            payload: [fields, tags],
            measurement: "sensors"
        }
    }


    node.status({ fill: "blue", shape: "dot", text: msg.sensor_name + "/" +
    msg.topic + ": " + Number(msg.payload) });


    return msgres
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 910
  'y': 1950
  wires:
    - - aede2387acfabe40
- id: 31367ce045ab32a2
  type: function
  z: ec75ad2cb670e9c0
  name: IsNumeric
  func: |-
    function isNumeric(n) {
        return !isNaN(parseFloat(n)) && isFinite(n);
    }

    // convert to numeric if possible
    if (isNumeric(msg.payload)) {
        msg.payload = Number(msg.payload)
    }

    return msg;
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 380
  'y': 1990
  wires:
    - - 0ab48e38c7515cbf
- id: ec4ab99b1e9b03d7
  type: switch
  z: ec75ad2cb670e9c0
  name: ''
  property: payload
  propertyType: msg
  rules:
    - t: istype
      v: number
      vt: number
    - t: istype
      v: boolean
      vt: boolean
    - t: else
  checkall: 'true'
  repair: false
  outputs: 3
  x: 720
  'y': 1990
  wires:
    - - 24518d39f0d7f3e8
    - - 24518d39f0d7f3e8
    - - 4daff368c2cff575
- id: 4daff368c2cff575
  type: debug
  z: ec75ad2cb670e9c0
  name: ZDebug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 890
  'y': 2010
  wires: []
- id: ae9f3e3b816d1937
  type: link out
  z: ec75ad2cb670e9c0
  name: link out 1
  mode: link
  links:
    - 8f74f3f76c223f4d
  x: 1115
  'y': 1950
  wires: []
- id: 17d6f5a85077df47
  type: function
  z: ec75ad2cb670e9c0
  name: sensors_zigbee_X
  func: >-
    var fieldName = "zigbee_" + msg.topic

    var fields = { [fieldName] : Number(msg.payload) }


    var tags = { "location": msg.sensor_name }


    var msgres = {
        topic: fieldName,
        payload: {
            payload: [fields, tags],
            measurement: "sensors"
        }
    }


    node.status({ fill: "blue", shape: "dot", text: msg.sensor_name + "/" +
    msg.topic + ": " + Number(msg.payload) });


    return msgres
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 920
  'y': 1900
  wires:
    - - aede2387acfabe40
- id: 837d2234bda1d724
  type: debug
  z: ec75ad2cb670e9c0
  name: ZDebug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 1170
  'y': 1900
  wires: []
- id: 164bfa497952db59
  type: switch
  z: ec75ad2cb670e9c0
  name: ''
  property: sensor_name
  propertyType: msg
  rules:
    - t: regex
      v: ^S.*
      vt: str
      case: false
    - t: else
  checkall: 'true'
  repair: false
  outputs: 2
  x: 720
  'y': 2050
  wires:
    - - 9a7c7cf4e50bd997
    - []
- id: 9a7c7cf4e50bd997
  type: debug
  z: ec75ad2cb670e9c0
  name: ZDebug
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 890
  'y': 2050
  wires: []
- id: c2bdb1f8fe501507
  type: change
  z: ec75ad2cb670e9c0
  name: state=TOGGLE
  rules:
    - t: set
      p: payload
      pt: msg
      to: '{"state":"TOGGLE"}'
      tot: json
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 760
  'y': 2560
  wires:
    - - 1959a89276377b62
- id: 1959a89276377b62
  type: mqtt out
  z: ec75ad2cb670e9c0
  name: ''
  topic: zigbee2mqtt/P02~Celier~OnOff/set
  qos: ''
  retain: ''
  respTopic: ''
  contentType: ''
  userProps: ''
  correl: ''
  expiry: ''
  broker: c38452a5.4f84e8
  x: 1280
  'y': 2560
  wires: []
- id: 81c37e8ebb9804b5
  type: mqtt out
  z: ec75ad2cb670e9c0
  name: ''
  topic: zigbee2mqtt/P03~Salon~OnOff01/set
  qos: ''
  retain: ''
  respTopic: ''
  contentType: ''
  userProps: ''
  correl: ''
  expiry: ''
  broker: c38452a5.4f84e8
  x: 1340
  'y': 2470
  wires: []
- id: bf06d3be07b1aa3a
  type: debug
  z: ec75ad2cb670e9c0
  name: ''
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 280
  'y': 2610
  wires: []
- id: 3591c75b692dd6c1
  type: switch
  z: ec75ad2cb670e9c0
  name: ''
  property: payload.action
  propertyType: msg
  rules:
    - t: eq
      v: 'on'
      vt: str
    - t: eq
      v: 'off'
      vt: str
  checkall: 'true'
  repair: false
  outputs: 2
  x: 560
  'y': 2690
  wires:
    - - abebbab3b6db912c
    - - 4b32ea4a743664e3
- id: 7932e8c57b15423f
  type: mqtt in
  z: ec75ad2cb670e9c0
  name: ''
  topic: zigbee2mqtt/R01~ChD~OnOff
  qos: '2'
  datatype: json
  broker: c38452a5.4f84e8
  nl: false
  rap: true
  rh: 0
  inputs: 0
  x: 210
  'y': 2650
  wires:
    - - bf06d3be07b1aa3a
      - 3591c75b692dd6c1
- id: abebbab3b6db912c
  type: change
  z: ec75ad2cb670e9c0
  name: state=ON
  rules:
    - t: set
      p: payload
      pt: msg
      to: '{"state":"ON"}'
      tot: json
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 750
  'y': 2670
  wires:
    - - f4669f975aff8c94
- id: d81ddfcbb68c35af
  type: mqtt out
  z: ec75ad2cb670e9c0
  name: ''
  topic: zigbee2mqtt/P01~ChD~Lit/set
  qos: ''
  retain: ''
  respTopic: ''
  contentType: ''
  userProps: ''
  correl: ''
  expiry: ''
  broker: c38452a5.4f84e8
  x: 1270
  'y': 2660
  wires: []
- id: 62ed4d71d6af731f
  type: inject
  z: ec75ad2cb670e9c0
  name: ''
  props:
    - p: payload
  repeat: ''
  crontab: ''
  once: false
  onceDelay: 0.1
  topic: ''
  payload: P01220vDam
  payloadType: str
  x: 760
  'y': 2630
  wires:
    - - 078f54d2c3f62bf7
- id: 4b32ea4a743664e3
  type: change
  z: ec75ad2cb670e9c0
  name: state=OFF
  rules:
    - t: set
      p: payload
      pt: msg
      to: '{"state":"OFF"}'
      tot: json
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 760
  'y': 2710
  wires:
    - - f4669f975aff8c94
- id: 078f54d2c3f62bf7
  type: change
  z: ec75ad2cb670e9c0
  name: state=TOGGLE
  rules:
    - t: set
      p: payload
      pt: msg
      to: '{"state":"TOGGLE"}'
      tot: json
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 950
  'y': 2630
  wires:
    - - d81ddfcbb68c35af
- id: e318f587a18e223e
  type: mqtt in
  z: ec75ad2cb670e9c0
  name: ''
  topic: zigbee2mqtt/R06~Salon~Cube
  qos: '2'
  datatype: json
  broker: c38452a5.4f84e8
  nl: false
  rap: true
  rh: 0
  inputs: 0
  x: 220
  'y': 2220
  wires:
    - - f611c36b26daf571
      - f7d25f3450feb71d
- id: f611c36b26daf571
  type: debug
  z: ec75ad2cb670e9c0
  name: ZDebugR06
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 280
  'y': 2180
  wires: []
- id: 87b3a42759b23e5b
  type: comment
  z: ec75ad2cb670e9c0
  name: Triggers -> Actions
  info: ''
  x: 150
  'y': 2110
  wires: []
- id: f7d25f3450feb71d
  type: switch
  z: ec75ad2cb670e9c0
  name: Cube action?
  property: payload.action
  propertyType: msg
  rules:
    - t: eq
      v: tap
      vt: str
    - t: eq
      v: rotate_right
      vt: str
    - t: eq
      v: rotate_left
      vt: str
    - t: eq
      v: shake
      vt: str
    - t: eq
      v: side
      vt: str
    - t: eq
      v: action
      vt: str
  checkall: 'true'
  repair: false
  outputs: 6
  x: 470
  'y': 2220
  wires:
    - - 0f6d5db35689dc7b
    - - 5c8e03f5abcc6c4f
    - - 5c8e03f5abcc6c4f
    - - 19e19d22577a26de
    - []
    - []
- id: 0f6d5db35689dc7b
  type: switch
  z: ec75ad2cb670e9c0
  name: Tap Side?
  property: payload.side
  propertyType: msg
  rules:
    - t: eq
      v: '0'
      vt: num
    - t: eq
      v: '3'
      vt: num
  checkall: 'true'
  repair: false
  outputs: 2
  x: 710
  'y': 2180
  wires:
    - - e0f4def5f27a20d1
    - - f1612c0ae6828f97
- id: 51936d202789c279
  type: mqtt in
  z: ec75ad2cb670e9c0
  name: ''
  topic: zigbee2mqtt/R07~Celier~Chaussures
  qos: '2'
  datatype: json
  broker: c38452a5.4f84e8
  nl: false
  rap: true
  rh: 0
  inputs: 0
  x: 240
  'y': 2560
  wires:
    - - 6e6da3a62b4c2160
- id: 6e6da3a62b4c2160
  type: switch
  z: ec75ad2cb670e9c0
  name: ''
  property: payload.action
  propertyType: msg
  rules:
    - t: eq
      v: single
      vt: str
    - t: eq
      v: double
      vt: str
  checkall: 'true'
  repair: false
  outputs: 2
  x: 560
  'y': 2560
  wires:
    - - c2bdb1f8fe501507
    - []
- id: 4904bc0c28088e53
  type: comment
  z: ec75ad2cb670e9c0
  name: Shake the cube to toggle cozy light
  info: ''
  x: 1330
  'y': 2380
  wires: []
- id: be2763750dc16e10
  type: change
  z: ec75ad2cb670e9c0
  name: state=TOGGLE
  rules:
    - t: set
      p: payload
      pt: msg
      to: '{"state":"TOGGLE"}'
      tot: json
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 1080
  'y': 2470
  wires:
    - - 81c37e8ebb9804b5
- id: 5b5d01c39c8b050e
  type: function
  z: ec75ad2cb670e9c0
  name: Compute
  func: >-
    var sensor_name = msg.topic.replace("zigbee2mqtt/","")


    // 0=up, 100=down

    var last_position = global.get("tidhome_cache." + sensor_name +
    ".last_position") || 0


    if(msg.payload.action_angle > 20) {
        position = Math.min(100, last_position + 25)
    } else if(msg.payload.action_angle < 20) {
        position = Math.max(0, last_position - 25)
    }


    global.set("tidhome_cache." + sensor_name + ".last_position", position);


    // pass through

    return {
        payload: {
            position: position
            }
        };
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 1060
  'y': 2330
  wires:
    - - 51f710c2cbb6e36c
- id: 5cc60cc5361ef586
  type: debug
  z: ec75ad2cb670e9c0
  name: ZDebugR06Rotate
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 740
  'y': 2220
  wires: []
- id: 51f710c2cbb6e36c
  type: debug
  z: ec75ad2cb670e9c0
  name: ''
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 1260
  'y': 2330
  wires: []
- id: 0cd9d34b9af9cb74
  type: switch
  z: ec75ad2cb670e9c0
  name: Rotate action?
  property: payload
  propertyType: msg
  rules:
    - t: hask
      v: action_angle
      vt: str
  checkall: 'true'
  repair: false
  outputs: 1
  x: 730
  'y': 2260
  wires:
    - - 5b5d01c39c8b050e
- id: b09f11acafb9618a
  type: change
  z: ec75ad2cb670e9c0
  name: CLOSE
  rules:
    - t: set
      p: action
      pt: msg
      to: CLOSE
      tot: str
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 1060
  'y': 2220
  wires:
    - - e45defb4b0e38b62
- id: f12c2500fc578913
  type: change
  z: ec75ad2cb670e9c0
  name: OPEN
  rules:
    - t: set
      p: action
      pt: msg
      to: OPEN
      tot: str
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 1050
  'y': 2180
  wires:
    - - e45defb4b0e38b62
- id: 0d82427f3ea8d425
  type: comment
  z: ec75ad2cb670e9c0
  name: Shake the cube to Open/Close shutters
  info: ''
  x: 1340
  'y': 2190
  wires: []
- id: 60b8f9c187ea8197
  type: link in
  z: ec75ad2cb670e9c0
  name: Zigbee-GroupB
  links:
    - e7e52fec716f59a2
  x: 175
  'y': 3300
  wires:
    - - 85150e703fc3107a
- id: 238f0552cc0c17f4
  type: inject
  z: ec75ad2cb670e9c0
  name: 14h30
  props:
    - p: payload
    - p: topic
      vt: str
  repeat: ''
  crontab: 30 14 * * *
  once: false
  onceDelay: 0.1
  topic: ''
  payloadType: date
  x: 150
  'y': 2910
  wires:
    - - 5711653aff0ebeda
- id: 5711653aff0ebeda
  type: change
  z: ec75ad2cb670e9c0
  name: state=ON
  rules:
    - t: set
      p: payload
      pt: msg
      to: '{"state":"ON"}'
      tot: json
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 320
  'y': 2910
  wires:
    - - c1506e088fe817bd
- id: 45c657b5aa67cb09
  type: change
  z: ec75ad2cb670e9c0
  name: state=OFF
  rules:
    - t: set
      p: payload
      pt: msg
      to: '{"state":"OFF"}'
      tot: json
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 330
  'y': 2950
  wires:
    - - c1506e088fe817bd
- id: f2801a14368b71aa
  type: inject
  z: ec75ad2cb670e9c0
  name: 22h30
  props:
    - p: payload
    - p: topic
      vt: str
  repeat: ''
  crontab: 30 22 * * *
  once: false
  onceDelay: 0.1
  topic: ''
  payloadType: date
  x: 150
  'y': 2950
  wires:
    - - 45c657b5aa67cb09
- id: 31f8d65b84424e75
  type: comment
  z: ec75ad2cb670e9c0
  name: Triggers -> Actions -> Aquarium
  info: ''
  x: 190
  'y': 2870
  wires: []
- id: e94b3d2f6a60fc41
  type: mqtt out
  z: ec75ad2cb670e9c0
  name: ''
  topic: zigbee2mqtt/P06~Sapin~OnOff/set
  qos: ''
  retain: ''
  respTopic: ''
  contentType: ''
  userProps: ''
  correl: ''
  expiry: ''
  broker: c38452a5.4f84e8
  x: 1330
  'y': 2420
  wires: []
- id: ab25ec62a461f551
  type: change
  z: ec75ad2cb670e9c0
  name: state=TOGGLE
  rules:
    - t: set
      p: payload
      pt: msg
      to: '{"state":"TOGGLE"}'
      tot: json
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 1080
  'y': 2420
  wires:
    - - e94b3d2f6a60fc41
- id: 19e19d22577a26de
  type: switch
  z: ec75ad2cb670e9c0
  name: Shake action?
  property: payload.side
  propertyType: msg
  rules:
    - t: eq
      v: '0'
      vt: str
    - t: eq
      v: '1'
      vt: str
    - t: eq
      v: '2'
      vt: str
    - t: eq
      v: '3'
      vt: str
    - t: eq
      v: '4'
      vt: str
    - t: eq
      v: '5'
      vt: str
  checkall: 'true'
  repair: false
  outputs: 6
  x: 730
  'y': 2330
  wires:
    - - e0f4def5f27a20d1
    - - ab25ec62a461f551
    - - ab25ec62a461f551
    - - f1612c0ae6828f97
    - - ab25ec62a461f551
    - - ab25ec62a461f551
- id: 4fdb9190057f63d6
  type: link in
  z: ec75ad2cb670e9c0
  name: Cmd-Light-Salon
  links:
    - c81f8f99a238d079
  x: 755
  'y': 2450
  wires:
    - - be2763750dc16e10
      - ab25ec62a461f551
- id: 3a5a0484a61b744e
  type: inject
  z: ec75ad2cb670e9c0
  name: OPEN
  props:
    - p: action
      v: OPEN
      vt: str
  repeat: ''
  crontab: ''
  once: false
  onceDelay: 0.1
  topic: ''
  x: 140
  'y': 3130
  wires:
    - - 3c2ea8d420d3f326
- id: c90d5de23f9d01d9
  type: function
  z: ec75ad2cb670e9c0
  name: Shift
  func: |-

    if(msg.topics.length > 0) {
        return [
            {
                topic: msg.topics.pop(0),
                position: msg.position
            },
            {
                topics: msg.topics,
                position: msg.position
            },
        ]
    }
  outputs: 2
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 880
  'y': 3140
  wires:
    - - 5bbe95588daa44b5
    - - 46e44c04560e551e
- id: 46e44c04560e551e
  type: delay
  z: ec75ad2cb670e9c0
  name: ''
  pauseType: delay
  timeout: '4'
  timeoutUnits: seconds
  rate: '1'
  nbRateUnits: '1'
  rateUnits: second
  randomFirst: '1'
  randomLast: '5'
  randomUnits: seconds
  drop: false
  allowrate: false
  outputs: 1
  x: 880
  'y': 3200
  wires:
    - - c90d5de23f9d01d9
- id: 5ed342cf9cafef09
  type: mqtt out
  z: ec75ad2cb670e9c0
  name: ''
  topic: ''
  qos: ''
  retain: ''
  respTopic: ''
  contentType: ''
  userProps: ''
  correl: ''
  expiry: ''
  broker: c38452a5.4f84e8
  x: 1220
  'y': 3140
  wires: []
- id: 1196f432a47f9d18
  type: inject
  z: ec75ad2cb670e9c0
  name: CLOSE
  props:
    - p: action
      v: CLOSE
      vt: str
  repeat: ''
  crontab: ''
  once: false
  onceDelay: 0.1
  topic: ''
  x: 140
  'y': 3180
  wires:
    - - 3c2ea8d420d3f326
- id: 54015e759adf6f9c
  type: link in
  z: ec75ad2cb670e9c0
  name: Zigbee-GroupA
  links:
    - e45defb4b0e38b62
    - a0f1b25d.56ebd8
    - fecb20f01567e4a8
  x: 175
  'y': 3080
  wires:
    - - 3c2ea8d420d3f326
- id: e45defb4b0e38b62
  type: link out
  z: ec75ad2cb670e9c0
  name: ''
  mode: link
  links:
    - 54015e759adf6f9c
  x: 1205
  'y': 2230
  wires: []
- id: d5012b227aa8a9f1
  type: comment
  z: ec75ad2cb670e9c0
  name: Triggers => Actions -> Shutters
  info: ''
  x: 190
  'y': 3030
  wires: []
- id: 5bbe95588daa44b5
  type: function
  z: ec75ad2cb670e9c0
  name: Position
  func: |-

    return {
        payload: {
            "position": msg.position
        },
        topic: "zigbee2mqtt/" + msg.topic + "/set"
    }
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 1060
  'y': 3140
  wires:
    - - 5ed342cf9cafef09
- id: f43e2331f0e24c97
  type: inject
  z: ec75ad2cb670e9c0
  name: 25%
  props:
    - p: action
      v: POSITION
      vt: str
    - p: position
      v: '25'
      vt: str
  repeat: ''
  crontab: ''
  once: false
  onceDelay: 0.1
  topic: ''
  x: 140
  'y': 3230
  wires:
    - - 3c2ea8d420d3f326
- id: 6484417009153f26
  type: change
  z: ec75ad2cb670e9c0
  name: 100=OPEN
  rules:
    - t: set
      p: position
      pt: msg
      to: '100'
      tot: str
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 650
  'y': 3130
  wires:
    - - c90d5de23f9d01d9
- id: 3184599136af5dd3
  type: switch
  z: ec75ad2cb670e9c0
  name: ''
  property: action
  propertyType: msg
  rules:
    - t: eq
      v: OPEN
      vt: str
    - t: eq
      v: CLOSE
      vt: str
    - t: eq
      v: POSITION
      vt: str
  checkall: 'false'
  repair: false
  outputs: 3
  x: 480
  'y': 3170
  wires:
    - - 6484417009153f26
    - - 2cb0799139d8bd91
    - - bfd4804414e77acf
- id: 2cb0799139d8bd91
  type: change
  z: ec75ad2cb670e9c0
  name: 0=CLOSE
  rules:
    - t: set
      p: position
      pt: msg
      to: '0'
      tot: str
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 640
  'y': 3170
  wires:
    - - c90d5de23f9d01d9
- id: bfd4804414e77acf
  type: change
  z: ec75ad2cb670e9c0
  name: '?=POSITION'
  rules: []
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 650
  'y': 3210
  wires:
    - - c90d5de23f9d01d9
- id: 3c2ea8d420d3f326
  type: change
  z: ec75ad2cb670e9c0
  name: Group A
  rules:
    - t: set
      p: topics
      pt: msg
      to: tidhome.groups.groupA
      tot: global
      dc: true
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 310
  'y': 3170
  wires:
    - - 3184599136af5dd3
- id: 85150e703fc3107a
  type: change
  z: ec75ad2cb670e9c0
  name: Group B
  rules:
    - t: set
      p: topics
      pt: msg
      to: tidhome.groups.groupB
      tot: global
      dc: true
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 310
  'y': 3300
  wires:
    - - 3184599136af5dd3
- id: c33f4def1ffb589e
  type: mqtt out
  z: ec75ad2cb670e9c0
  name: ''
  topic: ''
  qos: ''
  retain: ''
  respTopic: ''
  contentType: ''
  userProps: ''
  correl: ''
  expiry: ''
  broker: c38452a5.4f84e8
  x: 840
  'y': 2930
  wires: []
- id: c1506e088fe817bd
  type: change
  z: ec75ad2cb670e9c0
  name: Group C
  rules:
    - t: set
      p: topics
      pt: msg
      to: tidhome.groups.groupC
      tot: global
      dc: true
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 490
  'y': 2930
  wires:
    - - 07fc3bdc3ad533e1
- id: 07fc3bdc3ad533e1
  type: function
  z: ec75ad2cb670e9c0
  name: State
  func: |-

    return {
        payload: {
            "state": msg.payload.state
        },
        topic: "zigbee2mqtt/" + msg.topics.pop(0) + "/set"
    }
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 670
  'y': 2930
  wires:
    - - c33f4def1ffb589e
