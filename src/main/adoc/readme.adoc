:toc:

ifdef::env-github[]
:imagesdir: /src/main/adoc/images
endif::[]

= Ti-DHome

This is a Home automation project. +
Pronounced "Ti d'Homme" stands for *little man* in French, or as short for *petite domotique*. +
This GIT project is a hat project with a set of sub-projects enabling Home Automation.

This project tries to offer a lot of flexibility in intergrating heterogeneous systems, while remaining simple: KISS (Keep It Simple Stupid).

image:schema-architecture.png[Overview]

.Example Usage
[TIP]
====
Sensors (DIY or proprietary) are sending room temperatures, motion or doors state. +
A small and flexible Node-Red workflow allows to orchestrate heaters based on simple rules around sensors values and/or schedule and/or external weather.
====

== Design

=== Principle

The source and explanation in this repository are following few principles:

* Avoid complex monolithic framework used here and there in automation
* Avoid using proprietary gateways named *boxes* such as any IKEA, Xiaomi, Amazon Echo, Leroy Merlin, etc
* Use (or re-use) available technology, avoid deprecation, but stay open to new technology
* Client(s)/server(s) plugs together using *ANY* progamming language by leveraging message queues (MQTT) when necessary
* DIY sensors or Web devices are using simple arduino sketches
* Each element (e.g. Timeseries datastore) can be any, or multiple, and are interchangeable
* Deploy as much as possible with automation in mind, using link:https://www.docker.com/[Docker]

=== Architecture

There are only few technical concepts:

* Communication of each element from the system is done through messaging system *MQTT bus* (mosquitto)
* *Node-red* enables loosely coupled custom workflow strategies

image:architecture-bus.png[Architecture]

In turns, this simplistic approach allows very flexible and powerful Home Automation.

=== Material

Hardware used for sensors/actors:

* Fanless low-consumption servers (e.g. Core i3 with SSD, or RaspberryPi)
* link:http://www.currentcost.com/product-envir.html[CurrentCost EnviR] to measure 230v main + 9 plugs
* link:http://www.rfxcom.com/[RFXtrx433] to record Weather Station measures, trigger Window motor openers, or monitor alarm
* link:https://aeotec.com/z-wave-usb-stick/[ZWave] or link:https://phoscon.de/en/conbee2[ZigBee] USB sticks as gateways (with minimal footprint) to proprietary devices
* link:https://github.com/kalemena/ti-dhome-web-relay-board[DIY Web relays board]
* link:https://github.com/kalemena/ti-dhome-sensors[DIY Arduino sensors 866Mhz] (15+ low cost sensors)
* link:https://kalemena.github.io/iot-tools/#sensors_teleinfo[Téléinfo (Electric French Main power counters)]
* Few cheap components

=== Dashboard

TIP: A simple Dashboard using Grafana and Victoria Metrics as storage.

image:dashboard-power-iinst.png[Dashboard Power - instant,1024]

* Shown on this dashboard :
** *Periode* : Current power cost period. "Heures Pleines" or "Heures Creuses" stands for high/low cost hours
** *Total* : Electricity provider serial info of current consumption. (Teleinfo - serial info)
** *Non-Heating* : Clamp meter on non-heating part of the house (CurrentCost clamp)
** *Consumers* : Clamp meters on various elements (Zigbee clamps)
** *Outlets* : Wall plugs (CurrentCost or Zigbee plugs)
** *Cost HCHP* : Computed costs, taking Low/High hours of Teleinfo into account
** *Cost if Base* : Computed standard costs, to compare with case of Low/High hours contract
** *Index* : Rolling indexes
** *X days* : Costs for the selected period and for the bigger consumers

image:dashboard-power-energy[Dashboard Power - Energy,1024]

* Shown on this dashboard :
** *Total Hourly* : Energy consummed by hour slots (kWh)
** *Total Daily* : Energy consummed by day slots (kWh)
** *Total Weekly* : Energy consummed by week slots (kWh) and on 12 weeks
** *Costs* by day/week/month(s)



image:dashboard-power-1.png[Dashboard Power,320,240]
image:dashboard-sensors-1.png[Dashboard Sensors,320,240]
image:dashboard-system-1.png[Dashboard System,320,240]

image:dashboard-system-2.png[Dashboard System,320,240]

== How-To

This project can be entirely or partialy reproduced. +
Hence this is not required to buy everything above mentioned to be working for Ti-Dhome. +
If you need to control ZigBee devices, just implement relevant part of this project.

=== Setup modules

==== Orchestrator

Central to all the Orchestration of IoT is a docker container with link:http://nodered.org[Node RED]. +
Node-Red enables loosely coupled custom workflow strategies. +
IoT devices can therefore be wired from monitoring to action. +
Node-Red is like the advanced modern IFTTT (If This Then That) service, with much much more powerful integration capabilities, at the cost a requiring a little bit more effort to use :-)

Because Ti-Dhome requires few defaults and libs installed, a specific Docker version is cooked. +
Check link:https://github.com/kalemena/docker-node-red[Ti-Dhome - Docker Node-Red (external git project)]

==== Databases & Monitoring

Use any, as appropriate for your use-case. +
Ti-Dhome uses link:https://github.com/VictoriaMetrics/VictoriaMetrics[Victoria Metrics] to store Timeseries on sensors metrics. +

Victoria Metrics is generally used in stack with monitoring of system, with link:https://github.com/influxdata/telegraf[Telegraf] and link:https://grafana.com/[Grafana]. +

==== IoT Gateways

Here are gateways integrated OK in Ti-Dhome:

* link:https://github.com/kalemena/ti-dhome-web-relay-board[Ti-Dhome - Web Relays (external git project)]
* link:https://github.com/kalemena/ti-dhome-sensors[Ti-Dhome - Sensors (external git project)]
* link:https://kalemena.github.io/iot-tools/#gateways_currentcost[Gateway USB CurrentCost]
* link:https://kalemena.github.io/iot-tools/#gateways_rfxtrx_433[Gateway USB RfxTrx433]
* link:https://kalemena.github.io/iot-tools/#sensors_teleinfo[Gateway USB Téléinfo]
* link:https://kalemena.github.io/iot-tools/#gateways_zigbee[ZigBee (example usage for Ti-DHome)]
* link:https://kalemena.github.io/iot-tools/#gateways_z_wave[ZWave (example usage for Ti-DHome)]

=== Deployment

* install link:https://www.docker.com/[Docker]
* clone this repository

    $ git clone https://github.com/kalemena/ti-dhome.git
    $ cd ti-dhome/src

* edit the docker-compose.yml to map your USB gateway devices.

* initialize few folders and config

    $ make init

* start Node-RED

    $ make start

** connect to link:http://localhost:1880[], change the project flow. 

==== Strategies (aka Node-red flows)

image:nodered-sensors-input.png[Node-RED Flows]

==== Security

    $ openssl req -subj '/CN=localhost' -x509 -newkey rsa:4096 -nodes -keyout key.pem -out cert.pem -days 365

// non-GitHub
ifndef::env-github[]

== Modules

:leveloffset: +2

include::modules/gateways-wifi-web-relay-board/readme.adoc[web relay]

include::modules/gateways-usb-teleinfo/readme.adoc[teleinfo]

include::modules/gateways-usb-rfxtrx433/readme.adoc[RfxTrx433]

include::modules/gateways-usb-currentcost/readme.adoc[Current Cost]

:leveloffset: -2

endif::[]

== Links

link:https://air.imag.fr/index.php/Developing_IoT_Mashups_with_Docker,_MQTT,_Node-RED,_InfluxDB,_Grafana[]
