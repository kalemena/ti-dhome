version: '3.7'

networks:
  default:

volumes:
  influxdb-data:
  victoria-metrics-data:
  grafana-data:

services:

  mqtt:
    image: eclipse-mosquitto:1.6
    restart: always

  zigbee2mqtt:
    image: koenkk/zigbee2mqtt:1.28.0
    restart: always
    ports:
      - 8181
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./tidhome/data:/app/data
      - /run/udev:/run/udev:ro
    devices:
      - /dev/ttyACM0:/dev/ttyACM0
    privileged: true
    environment:
      - TZ=Europe/Paris
    networks:
      default:
        aliases:
          - zigbee2mqtt.tidhome.local

  influxdb:
    image: influxdb:1.8.6
    restart: always
    ports:
      - 8083
      - 8086
    volumes: 
      - ./etc/influxdb/scripts:/docker-entrypoint-initdb.d
      # - ./var/lib/influxdb:/var/lib/influxdb:rw
      # - ./var/lib/.influx_history:/.influx_history
      - influxdb-data:/var/lib/influxdb:rw
    environment:
      INFLUXDB_DB: "telegraf"
      # Memory usage reduction (bugs after sometimes)
      INFLUXDB_REPORTING_DISABLED: "true"
      INFLUXDB_MONITOR_STORE_ENABLED: "false"
      INFLUXDB_META_LOGGING_ENABLED: "true"
      INFLUXDB_DATA_QUERY_LOG_ENABLED: "false"
      # Creds
      INFLUXDB_ADMIN_ENABLED: "true"
      INFLUXDB_ADMIN_USER: ${INFLUXDB_ADMIN_USER:-default}
      INFLUXDB_ADMIN_PASSWORD: ${INFLUXDB_ADMIN_PASSWORD:-password}
      INFLUXDB_USER: ${INFLUXDB_USER:-default}
      INFLUXDB_USER_PASSWORD: ${INFLUXDB_USER_PASSWORD:-password}

  victoriametrics:
    image: victoriametrics/victoria-metrics:v1.87.1
    restart: always
    ports:
      - 8428:8428
    volumes:
      - victoria-metrics-data:/victoria-metrics-data
    command:
      - "--retentionPeriod=3y"
      # - "--storageDataPath=/storage"

  nodered:
    #image: kalemena/node-red:latest
    build: .
    restart: always
    ports:
     - 1880
    volumes:
     - ./etc/tidhome:/etc/tidhome
     - ./tidhome:/opt/tidhome
     - ./tidhome/config:/home/nodered/.node-red
    # - ./var/log/node-red:/var/log/node-red
    # - /home/nodered/.node-red/settings.js      # Default Settings file
    # - /data/flows.json                         # Default Flows file
    devices:
     - "/dev/ttyCurrenCost:/dev/ttyCurrenCost"
     - "/dev/ttyJeeLink:/dev/ttyJeeLink"
    #  - "/dev/ttyZWave:/dev/ttyZWave"
    # environment:
    #  - FLOWS=/opt/tidhome/flows/tidhome-flows.json
    env_file:
     - .env

  telegraf:
    image: telegraf
    # network_mode: host
    hostname: telegraf
    restart: always
    user: telegraf:998
    volumes:
      - ./etc/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /sys:/rootfs/sys:ro
      - /proc:/rootfs/proc:ro
      - /etc:/rootfs/etc:ro      
    environment:
      HOST_PROC: /rootfs/proc
      HOST_SYS: /rootfs/sys
      HOST_ETC: /rootfs/etc

  grafana:
    image: grafana/grafana:9.1.5
    restart: always
    ports:
      - "3000:3000"
    volumes:
      # - ./etc/grafana:/etc/grafana
      # - ./var/lib/grafana:/var/lib/grafana
      # - ./var/log/grafana:/var/log/grafana
      - grafana-data:/var/lib/grafana
      - ./etc/grafana/provisioning/:/etc/grafana/provisioning/
      - ./etc/grafana/canvas/:/usr/share/grafana/public/img/bg/:ro
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-default}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-password}
      GF_INSTALL_PLUGINS: grafana-worldmap-panel,grafana-polystat-panel
    env_file:
      - .env

  gateway:
    image: nginx
    restart: always
    ports:
     - "80:80"
    volumes:
     - ./etc/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
     - ./etc/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
     - ./usr/share/nginx/html:/usr/share/nginx/html
     # - /var/log/nginx:/var/log/nginx
