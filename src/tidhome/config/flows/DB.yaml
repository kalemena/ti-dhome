- id: d88a69c4.1942c8
  type: tab
  label: DB
  disabled: false
  info: ''
- id: ed8532c35449ea5d
  type: junction
  z: d88a69c4.1942c8
  x: 240
  'y': 320
  wires:
    - - 7e3ea563.cfecfc
      - 2b444ab.4ee2eb6
- id: 994a7a64bc1c7656
  type: junction
  z: d88a69c4.1942c8
  x: 100
  'y': 970
  wires:
    - - '9581410703628258'
      - 6e5458755ca35f1b
      - 9147ca10781b15f4
- id: 204ba00bb6a13bac
  type: junction
  z: d88a69c4.1942c8
  x: 360
  'y': 1010
  wires:
    - - cc2f0f7f0427b58c
- id: fb7400d80e8fad49
  type: junction
  z: d88a69c4.1942c8
  x: 500
  'y': 1490
  wires:
    - - e6dfbafc8c3042c3
      - 8f1a3faa6d1e85ef
- id: cc675ec4.106d
  type: comment
  z: d88a69c4.1942c8
  name: Sensors - Heaters/Power/RFM868
  info: ''
  x: 180
  'y': 120
  wires: []
- id: 90d304a9.c871a
  type: mqtt in
  z: d88a69c4.1942c8
  name: sensors/#
  topic: sensors/#
  qos: '2'
  datatype: json
  broker: c38452a5.4f84e8
  inputs: 0
  x: 100
  'y': 160
  wires:
    - - dcd509f1.d56dd
- id: 14def27.355280e
  type: debug
  z: d88a69c4.1942c8
  name: Debug
  active: false
  tosidebar: true
  console: true
  tostatus: false
  complete: 'true'
  targetType: full
  x: 420
  'y': 160
  wires: []
- id: dcd509f1.d56dd
  type: function
  z: d88a69c4.1942c8
  name: Store Global
  func: |-
    var topicNodesPrefix = 'tidhome.sensors.' + msg.payload.gateway + '.nodes'
    var nodes = global.get(topicNodesPrefix) || [];
    for (var i = 0; i < nodes.length; i++) {
        if(nodes[i].id === msg.payload.id) {
            // found node
            let entryStr = (msg.payload.entry != undefined) ? ('-' + msg.payload.entry) : ''
            global.set(topicNodesPrefix + '[' + i + '].' + msg.payload.type + entryStr, msg.payload.value);
            global.set(topicNodesPrefix + '[' + i + '].timestamp', msg.payload.timestamp);
        }
    }
    // pass through
    return msg;
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 260
  'y': 160
  wires:
    - - 14def27.355280e
- id: 694da039.ceca8
  type: catch
  z: d88a69c4.1942c8
  name: ''
  scope: null
  uncaught: false
  x: 100
  'y': 80
  wires:
    - - 950a0758.599f88
- id: 950a0758.599f88
  type: link out
  z: d88a69c4.1942c8
  name: General CatchAll
  links:
    - 1bf42829.b3e0b8
  x: 255
  'y': 80
  wires: []
- id: 716819cb.d00088
  type: comment
  z: d88a69c4.1942c8
  name: insert - events
  info: ''
  x: 110
  'y': 260
  wires: []
- id: bf874566.5d9478
  type: influxdb out
  z: d88a69c4.1942c8
  influxdb: ab73d852ece55e2a
  name: ''
  measurement: ''
  precision: ''
  retentionPolicy: ''
  database: ''
  retentionPolicyV18Flux: ''
  org: ''
  bucket: ''
  x: 540
  'y': 300
  wires: []
- id: 2b444ab.4ee2eb6
  type: debug
  z: d88a69c4.1942c8
  name: ''
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 330
  'y': 350
  wires: []
- id: 363803a4.b81044
  type: mqtt in
  z: d88a69c4.1942c8
  name: sensors
  topic: sensors
  qos: '2'
  datatype: json
  broker: c38452a5.4f84e8
  nl: false
  rap: false
  inputs: 0
  x: 90
  'y': 300
  wires:
    - - ed8532c35449ea5d
- id: 7e3ea563.cfecfc
  type: function
  z: d88a69c4.1942c8
  name: Wrap
  func: |
    var msgres = msg.payload
    return msgres;
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 330
  'y': 300
  wires:
    - - bf874566.5d9478
      - 1dcfd422.bd14fc
      - 5aec7656638b8a7b
- id: 1dcfd422.bd14fc
  type: debug
  z: d88a69c4.1942c8
  name: ''
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 510
  'y': 340
  wires: []
- id: 5aec7656638b8a7b
  type: influxdb out
  z: d88a69c4.1942c8
  influxdb: 786c015f0b3c18d1
  name: ''
  measurement: ''
  precision: ''
  retentionPolicy: ''
  database: ''
  retentionPolicyV18Flux: ''
  org: ''
  bucket: ''
  x: 550
  'y': 260
  wires: []
- id: e72a9a6d97ae5b4a
  type: link in
  z: d88a69c4.1942c8
  name: DB-Insert
  links:
    - 78c90ae53c32e0c1
    - 217fc7c76bf682ea
    - bd608bdcef55352f
  x: 125
  'y': 350
  wires:
    - - ed8532c35449ea5d
- id: c7ee104a98cf18f3
  type: moment
  z: d88a69c4.1942c8
  name: Parse Epoch
  topic: ''
  input: payload.timestamp
  inputType: msg
  inTz: Europe/Paris
  adjAmount: 0
  adjType: days
  adjDir: add
  format: YYYY-MM-DD
  locale: POSIX
  output: payload.isoDate
  outputType: msg
  outTz: Europe/Paris
  x: 430
  'y': 710
  wires:
    - - 2366bd1e3e03afb8
      - b3652a8e55e370f4
      - b4b61009fc7b0feb
- id: 2366bd1e3e03afb8
  type: function
  z: d88a69c4.1942c8
  name: Tempo
  func: >-
    msg.topic = "tempo"


    var datesTempo = global.get("edf.tempo")


    if (datesTempo[msg.payload.isoDate] != undefined) {
        msg.payload.color = datesTempo[msg.payload.isoDate].color
    } else {
        msg.payload.color = 'blue'
    }


    global.set('edf.tempo.colors.' + msg.payload.color, 1);


    switch (msg.payload.period) {

        case 'HC':

            switch (msg.payload.color) {
                case "blue":
                    msg.payload.costUnit = Number(0.0970)
                    break;

                case "white":
                    msg.payload.costUnit = Number(0.1140)
                    break;

                case 'red':
                    msg.payload.costUnit = Number(0.1216)
                    break;
            }        
            
            break;

        case 'HP':

            switch (msg.payload.color) {
                case "blue":
                    msg.payload.costUnit = Number(0.1249)
                    break;

                case "white":
                    msg.payload.costUnit = Number(0.1508)
                    break;

                case 'red':
                    msg.payload.costUnit = Number(0.6712)
                    break;
            }

            break;    
    }


    global.set('edf.tempo.colors.' + msg.payload.color + "-" +
    msg.payload.period, msg.payload.costUnit);


    msg.payload.cost = msg.payload.costUnit * Number(msg.payload.value) / 1000


    return msg;
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 610
  'y': 710
  wires:
    - - 7733c07030c21098
- id: 3bee84a27e6cd59c
  type: function
  z: d88a69c4.1942c8
  name: scroll energy
  func: |-

    // Trigger as many as days
    //for (var dayEnergy in msg.payload.data.result[0].values) {
    for (var j = 0; j < msg.payload.data.result[0].values.length; j++) {
        let dayData = msg.payload.data.result[0].values[j]
        node.send(
            [
                { 
                    payload: {
                        timestamp: dayData[0] * 1000,
                        value: Number(dayData[1]),
                        period: msg.period
                    }
                }
            ]);
    }

    return null;
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 240
  'y': 710
  wires:
    - - c7ee104a98cf18f3
- id: 7733c07030c21098
  type: Topic Frequencies
  z: d88a69c4.1942c8
  name: Freqs
  units: hours
  interval: 1
  reportUnits: minutes
  reportInterval: 1
  topicKey: topic
  valueKey: payload.cost
  alignToClock: true
  generator: internal
  x: 820
  'y': 750
  wires:
    - - ab9d4b85d889183c
      - fbbf19c3b6f8e430
    - []
- id: b3652a8e55e370f4
  type: function
  z: d88a69c4.1942c8
  name: HC/HP
  func: |-
    msg.topic = "hchp"

    switch (msg.payload.period) {
        case 'HC':
            msg.payload.costUnit = Number(0.1615)
            break;

        case 'HP':
            msg.payload.costUnit = Number(0.2228)
            break;    
    }

    msg.payload.cost = msg.payload.costUnit * Number(msg.payload.value) / 1000

    return msg;
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 620
  'y': 750
  wires:
    - - 7733c07030c21098
- id: b4b61009fc7b0feb
  type: function
  z: d88a69c4.1942c8
  name: Base
  func: |-
    msg.topic = "base"
    msg.payload.costUnit = Number(0.2062)
    msg.payload.cost = msg.payload.costUnit * Number(msg.payload.value) / 1000

    return msg;
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 610
  'y': 790
  wires:
    - - 7733c07030c21098
- id: 9aa81642091a436b
  type: inject
  z: d88a69c4.1942c8
  name: Init
  props: []
  repeat: ''
  crontab: ''
  once: true
  onceDelay: 0.1
  topic: ''
  x: 90
  'y': 470
  wires:
    - - f4df2ed060031650
      - a5ea9f561f8a2b2a
      - 432439ee8b7f21ec
- id: 0d6fb4c44fbd1fd0
  type: moment
  z: d88a69c4.1942c8
  name: dateISO
  topic: ''
  input: timeFrom
  inputType: msg
  inTz: Europe/Paris
  adjAmount: 0
  adjType: days
  adjDir: add
  format: YYYY-MM-DD
  locale: POSIX
  output: dateISO
  outputType: msg
  outTz: Europe/Paris
  x: 400
  'y': 870
  wires:
    - - 3c57121b8d27c57c
- id: f4df2ed060031650
  type: file in
  z: d88a69c4.1942c8
  name: EDF - Tempo 2022
  filename: /etc/tidhome/EDF-Tempo-2022.csv
  filenameType: str
  format: utf8
  chunk: false
  sendError: false
  encoding: utf8
  allProps: false
  x: 300
  'y': 470
  wires:
    - - 302e9d35b9f224cd
- id: 302e9d35b9f224cd
  type: csv
  z: d88a69c4.1942c8
  name: ''
  sep: ','
  hdrin: true
  hdrout: ''
  multi: mult
  ret: \n
  temp: ''
  skip: '0'
  strings: true
  include_empty_strings: false
  include_null_values: false
  x: 470
  'y': 470
  wires:
    - - 598f547a1ac99cb2
- id: eb9dbd2cca4b2e93
  type: debug
  z: d88a69c4.1942c8
  name: Config-EDF
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 790
  'y': 550
  wires: []
- id: 598f547a1ac99cb2
  type: function
  z: d88a69c4.1942c8
  name: store global
  func: |-

    for (var j = 0; j < msg.payload.length; j++) {
        let dayData = msg.payload[j]
        global.set('edf.tempo.' + dayData.date, dayData);
    }

    return null;
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 610
  'y': 470
  wires:
    - - eb9dbd2cca4b2e93
- id: a5ea9f561f8a2b2a
  type: change
  z: d88a69c4.1942c8
  name: store facts
  rules:
    - t: set
      p: edf.costs.base
      pt: global
      to: '20.62'
      tot: num
    - t: set
      p: edf.costs.hc
      pt: global
      to: '16.15'
      tot: num
    - t: set
      p: edf.costs.hp
      pt: global
      to: '22.28'
      tot: num
    - t: set
      p: edf.tempo.colors
      pt: global
      to: '{"blue":0,"white":0,"red":0}'
      tot: json
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 280
  'y': 550
  wires:
    - - eb9dbd2cca4b2e93
- id: 3c9ba4b57c4a6219
  type: comment
  z: d88a69c4.1942c8
  name: Mathematics - power - config
  info: ''
  x: 160
  'y': 420
  wires: []
- id: 432439ee8b7f21ec
  type: file in
  z: d88a69c4.1942c8
  name: EDF - Tempo 2023
  filename: /etc/tidhome/EDF-Tempo-2023.csv
  filenameType: str
  format: utf8
  chunk: false
  sendError: false
  encoding: utf8
  allProps: false
  x: 300
  'y': 510
  wires:
    - - 302e9d35b9f224cd
- id: 1eb90a76313ade10
  type: comment
  z: d88a69c4.1942c8
  name: 'Mathematics - power - formula #1 - query_range'
  info: ''
  x: 220
  'y': 630
  wires: []
- id: ac63d8bf1ed66e71
  type: comment
  z: d88a69c4.1942c8
  name: 'Mathematics - power - formula #2 - scroll+offset'
  info: ''
  x: 220
  'y': 830
  wires: []
- id: 15eee1a293c595fd
  type: inject
  z: d88a69c4.1942c8
  name: ''
  props:
    - p: timeStart
      v: '1652382872000'
      vt: num
    - p: timeStart2022May
      v: '1652382872000'
      vt: num
    - p: timeStart2022Nov
      v: '1667282400000'
      vt: num
    - p: timeStart2023
      v: '1672552800000'
      vt: num
    - p: timeEnd
      v: ''
      vt: date
  repeat: ''
  crontab: ''
  once: false
  onceDelay: 0.1
  topic: ''
  x: 90
  'y': 870
  wires:
    - - ae0d4edaa0a1ecc3
- id: 81d9d4e81ec82ddf
  type: debug
  z: d88a69c4.1942c8
  name: 'Debug Fetch #2'
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 620
  'y': 920
  wires: []
- id: ae0d4edaa0a1ecc3
  type: function
  z: d88a69c4.1942c8
  name: scroll days
  func: |-

    let timeDay1 = msg.timeStart
    let timeEnd = msg.timeEnd

    while (timeDay1 < timeEnd) {
        // day1 => day2 = 1 full day
        let timeDay2 = timeDay1 + Number(86400 * 1000)

        node.send(
            [
                {
                    timeFrom: timeDay1,
                    timeTo: timeDay2,
                    timeEnd: timeEnd,
                    period: 'HC'
                },
                {
                    timeFrom: timeDay1,
                    timeTo: timeDay2,
                    timeEnd: timeEnd,
                    period: 'HP'
                }
            ]);

        // increment
        timeDay1 = timeDay2
    }

    return null;
  outputs: 2
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 240
  'y': 870
  wires:
    - - 0d6fb4c44fbd1fd0
    - - 0d6fb4c44fbd1fd0
- id: 3c57121b8d27c57c
  type: function
  z: d88a69c4.1942c8
  name: Query HC/HP
  func: >-
    msg.vmQuery = 'avg((sensors_teleinfo_HC' + msg.period +
    '{db="sensors",location="main"} @ ' + (msg.timeTo / 1000) 
        + '- (sensors_teleinfo_HC' + msg.period + '{db="sensors",location="main"} @ ' + (msg.timeFrom / 1000)
        + ')) / 1000)'
    msg.vmURL = "http://victoriametrics:8428/api/v1/query_range"

    // msg.vmRangeStart = "2023-04-25T06:00:01.000Z"

    //msg.vmRangeEnd = "2023-04-30T06:00:01.000Z"


    msg.url = msg.vmURL 
        + "?query=" + msg.vmQuery 
    //    + "&start=" + msg.vmRangeStart

    //    + "&end=" + msg.vmRangeEnd

    //    + "&step=1d"
        
    return msg;
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 250
  'y': 920
  wires:
    - - 3daae04fa5ad767b
- id: 3daae04fa5ad767b
  type: http request
  z: d88a69c4.1942c8
  name: Query
  method: GET
  ret: obj
  paytoqs: ignore
  url: ''
  tls: ''
  persist: false
  proxy: ''
  insecureHTTPParser: false
  authType: ''
  senderr: false
  headers: []
  x: 430
  'y': 920
  wires:
    - - 81d9d4e81ec82ddf
      - 994a7a64bc1c7656
- id: '9581410703628258'
  type: function
  z: d88a69c4.1942c8
  name: Base
  func: |-
    msg.topic = "base"
    msg.costUnit = Number(0.2062)

    if (msg.payload.data.result[0].values.length > 0) {
        let dayData = msg.payload.data.result[0].values[0]
        let daykWh = Number(dayData[1])

        let dayCost = msg.costUnit * daykWh

        return {
            cost: dayCost,
            topic: msg.topic
        }
    }

    return null
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 220
  'y': 970
  wires:
    - - 204ba00bb6a13bac
- id: ab9d4b85d889183c
  type: debug
  z: d88a69c4.1942c8
  name: 'Debug #1'
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 980
  'y': 750
  wires: []
- id: d4dcb78a85b8fd01
  type: function
  z: d88a69c4.1942c8
  name: periods
  func: |-
    return [ 
        { 
            period: 'HC'
        },
        {
            period: 'HP'
        }
        ]
  outputs: 2
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 230
  'y': 670
  wires:
    - - ec27a942cfa78c58
    - - ec27a942cfa78c58
- id: 942458445b49915c
  type: inject
  z: d88a69c4.1942c8
  name: ''
  props: []
  repeat: ''
  crontab: ''
  once: false
  onceDelay: 0.1
  topic: ''
  x: 90
  'y': 670
  wires:
    - - d4dcb78a85b8fd01
- id: ec27a942cfa78c58
  type: function
  z: d88a69c4.1942c8
  name: Query
  func: >-
    msg.vmQuery = 'last_over_time(sum(increase(sensors_teleinfo_HC' + msg.period
    + '{location="test2"}[1d]))[1d])'

    msg.vmURL = "http://vmtest:8428/api/v1/query_range"

    msg.vmRangeStart = "2022-05-01T06:00:01.000Z"

    msg.vmRangeEnd = "2023-05-01T06:00:01.000Z"


    msg.url = msg.vmURL 
        + "?query=" + msg.vmQuery 
        + "&start=" + msg.vmRangeStart
        + "&end=" + msg.vmRangeEnd
        + "&step=1d"
        
    return msg;
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 410
  'y': 670
  wires:
    - - 61321c793b31fe9b
- id: 61321c793b31fe9b
  type: http request
  z: d88a69c4.1942c8
  name: Fetch DB
  method: GET
  ret: obj
  paytoqs: ignore
  url: ''
  tls: ''
  persist: false
  proxy: ''
  insecureHTTPParser: false
  authType: ''
  senderr: false
  headers: []
  x: 560
  'y': 670
  wires:
    - - 3bee84a27e6cd59c
      - b9eaf33614dd786a
- id: b9eaf33614dd786a
  type: debug
  z: d88a69c4.1942c8
  name: 'Debug Fetch #1'
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 740
  'y': 670
  wires: []
- id: 6e5458755ca35f1b
  type: function
  z: d88a69c4.1942c8
  name: HC/HP
  func: |-
    msg.topic = "hchp"

    switch (msg.period) {
        case 'HC':
            msg.costUnit = Number(0.1615)
            break;

        case 'HP':
            msg.costUnit = Number(0.2228)
            break;    
    }

    if (msg.payload.data.result[0].values.length > 0) {
        let dayData = msg.payload.data.result[0].values[0]
        let daykWh = Number(dayData[1])

        let dayCost = msg.costUnit * daykWh

        return {
            cost: dayCost,
            topic: msg.topic
        }
    }

    return null
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 230
  'y': 1010
  wires:
    - - 204ba00bb6a13bac
- id: cc2f0f7f0427b58c
  type: Topic Frequencies
  z: d88a69c4.1942c8
  name: Freqs
  units: hours
  interval: 1
  reportUnits: minutes
  reportInterval: 1
  topicKey: topic
  valueKey: cost
  alignToClock: true
  generator: internal
  x: 440
  'y': 1010
  wires:
    - - bb33ba25cd6b92e2
      - b4f824ad67b0be80
    - []
- id: bb33ba25cd6b92e2
  type: debug
  z: d88a69c4.1942c8
  name: 'Debug #2'
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 600
  'y': 1010
  wires: []
- id: 9147ca10781b15f4
  type: function
  z: d88a69c4.1942c8
  name: Tempo
  func: >-
    msg.topic = "tempo"


    var datesTempo = global.get("edf.tempo")


    if (datesTempo[msg.dateISO] != undefined) {
        msg.color = datesTempo[msg.dateISO].color
    } else {
        msg.color = 'blue'
    }


    switch (msg.period) {

        case 'HC':

            switch (msg.color) {
                case "blue":
                    msg.costUnit = Number(0.0970)
                    break;

                case "white":
                    msg.costUnit = Number(0.1140)
                    break;

                case 'red':
                    msg.costUnit = Number(0.1216)
                    break;
            }        
            
            break;

        case 'HP':

            switch (msg.color) {
                case "blue":
                    msg.costUnit = Number(0.1249)
                    break;

                case "white":
                    msg.costUnit = Number(0.1508)
                    break;

                case 'red':
                    msg.costUnit = Number(0.6712)
                    break;
            }

            break;    
    }


    global.set('edf.tempo.colors.' + msg.color + "-" + msg.period,
    msg.costUnit);


    if (msg.payload.data.result[0].values.length > 0) {
        let dayData = msg.payload.data.result[0].values[0]
        let daykWh = Number(dayData[1])

        let dayCost = msg.costUnit * daykWh

        return {
            cost: dayCost,
            topic: msg.topic
        }
    }


    return null
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 220
  'y': 1050
  wires:
    - - 204ba00bb6a13bac
- id: fbbf19c3b6f8e430
  type: change
  z: d88a69c4.1942c8
  name: ''
  rules:
    - t: set
      p: edf.costs.formula1
      pt: global
      to: topics
      tot: msg
      dc: true
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 1040
  'y': 800
  wires:
    - []
- id: b4f824ad67b0be80
  type: change
  z: d88a69c4.1942c8
  name: ''
  rules:
    - t: set
      p: edf.costs.formula2
      pt: global
      to: topics
      tot: msg
      dc: true
  action: ''
  property: ''
  from: ''
  to: ''
  reg: false
  x: 660
  'y': 1060
  wires:
    - []
- id: f71dc1879ec3e214
  type: comment
  z: d88a69c4.1942c8
  name: Migrate - power - InfluxDB
  info: ''
  x: 150
  'y': 1240
  wires: []
- id: 34b91b78d80e9b18
  type: file in
  z: d88a69c4.1942c8
  name: EDF - Timeline miss
  filename: /etc/tidhome/EDF-Migration-holes.csv
  filenameType: str
  format: utf8
  chunk: false
  sendError: false
  encoding: utf8
  allProps: false
  x: 270
  'y': 1450
  wires:
    - - d7c8b9aa4ece1574
- id: d7c8b9aa4ece1574
  type: csv
  z: d88a69c4.1942c8
  name: ''
  sep: ','
  hdrin: true
  hdrout: ''
  multi: mult
  ret: \n
  temp: ''
  skip: '0'
  strings: true
  include_empty_strings: false
  include_null_values: false
  x: 440
  'y': 1450
  wires:
    - - b0e9f1b5a6dca969
      - 205520c7b4338967
- id: 09cec3590c9481ab
  type: inject
  z: d88a69c4.1942c8
  name: ''
  props:
    - p: sensorLocation
      v: test
      vt: str
  repeat: ''
  crontab: ''
  once: false
  onceDelay: 0.1
  topic: ''
  x: 90
  'y': 1450
  wires:
    - - 34b91b78d80e9b18
- id: b0e9f1b5a6dca969
  type: debug
  z: d88a69c4.1942c8
  name: debug 9
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'false'
  statusVal: ''
  statusType: auto
  x: 590
  'y': 1450
  wires: []
- id: 205520c7b4338967
  type: split
  z: d88a69c4.1942c8
  name: ''
  splt: \n
  spltType: str
  arraySplt: 1
  arraySpltType: len
  stream: false
  addname: ''
  x: 220
  'y': 1490
  wires:
    - - 1df7fa1d5bbf8fe0
- id: e6dfbafc8c3042c3
  type: debug
  z: d88a69c4.1942c8
  name: debug 10
  active: true
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 590
  'y': 1490
  wires: []
- id: 1df7fa1d5bbf8fe0
  type: function
  z: d88a69c4.1942c8
  name: Query Insert VM
  func: >-
    msg.vmURL = "http://vmtest:8428/api/v1/import/prometheus"


    let indexHC = parseInt(Number(msg.payload.IndexHC))

    let indexHP = parseInt(Number(msg.payload.IndexHP))


    let incHC = parseInt(Number(msg.payload.HC))

    let incHP = parseInt(Number(msg.payload.HP))


    let url = msg.vmURL + "?timestamp=" + (new
    Date(msg.payload.timestamp).getTime())

    let payloadHC = 'sensors_teleinfo_HCHC{location="' + msg.sensorLocation +
    '"} ' + Number(indexHC + incHC)

    let payloadHP = 'sensors_teleinfo_HCHP{location="' + msg.sensorLocation +
    '"} ' + Number(indexHP + incHP)


    return [
        {
            url: url,
            payload: payloadHC
        },
        {
            url: url,
            payload: payloadHP
        }
    ]
  outputs: 2
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 390
  'y': 1490
  wires:
    - - fb7400d80e8fad49
    - - fb7400d80e8fad49
- id: b2ef45d51966e389
  type: comment
  z: d88a69c4.1942c8
  name: Migrate - power - fix timeline
  info: ''
  x: 160
  'y': 1410
  wires: []
- id: 1eae10dbef23d854
  type: debug
  z: d88a69c4.1942c8
  name: debug 11
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 360
  'y': 1530
  wires: []
- id: 8f1a3faa6d1e85ef
  type: http request
  z: d88a69c4.1942c8
  name: Query
  method: POST
  ret: txt
  paytoqs: ignore
  url: ''
  tls: ''
  persist: false
  proxy: ''
  insecureHTTPParser: false
  authType: ''
  senderr: false
  headers: []
  x: 220
  'y': 1530
  wires:
    - - 1eae10dbef23d854
- id: a44be782cf95fa64
  type: influxdb in
  z: d88a69c4.1942c8
  influxdb: ab73d852ece55e2a
  name: ''
  query: ''
  rawOutput: false
  precision: ''
  retentionPolicy: ''
  org: organisation
  x: 570
  'y': 1280
  wires:
    - - e462087481339fba
      - dfac1e036667f158
- id: b4b276be4ca6c350
  type: inject
  z: d88a69c4.1942c8
  name: ''
  props:
    - p: payload
    - p: sensorRangeStart
      v: '2022-01-01T00:00:01Z'
      vt: str
    - p: sensorRangeEnd
      v: '2022-02-01T00:00:01Z'
      vt: str
  repeat: ''
  crontab: ''
  once: false
  onceDelay: 0.1
  topic: ''
  payload: 'teleinfo-HCHP,teleinfo-HCHC'
  payloadType: str
  x: 90
  'y': 1280
  wires:
    - - a39d60e2d87c48f8
- id: e462087481339fba
  type: debug
  z: d88a69c4.1942c8
  name: debug 12
  active: true
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 750
  'y': 1240
  wires: []
- id: 1d29eef22cdeb1fa
  type: function
  z: d88a69c4.1942c8
  name: Query Influx
  func: |-
    msg.query = "select * from five_years.sensors_1h WHERE "
    //msg.query = "select * from one_year.sensors_15m WHERE "
        + "type='" + msg.payload + "' "
        + "AND time > '" + msg.sensorRangeStart + "' "
        + "AND time < '" + msg.sensorRangeEnd + "'"

    return msg;
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 390
  'y': 1280
  wires:
    - - a44be782cf95fa64
- id: dfac1e036667f158
  type: function
  z: d88a69c4.1942c8
  name: scroll results
  func: |-
    function sleep(ms) {
        return new Promise((resolve) => {
            setTimeout(resolve, ms);
        });
    }   

    let timeCurrent = -1
    let timeExpected = -1
    let lastData = {}

    // Trigger as many hours returned
    for (var j = 0; j < msg.payload.length; j++) {

        let dataCurrent = msg.payload[j]
        let timeCurrent = new Date(dataCurrent.time).getTime()

        // expected time => 1st output
        if (timeCurrent == timeExpected) {
            node.send(
                [
                    {
                        payload: {
                            time: dataCurrent.time,
                            value: dataCurrent.value_1h,
                            location: dataCurrent.location,
                            type: dataCurrent.type
                        },
                        time: timeCurrent,
                        timeExpected: timeExpected
                    },
                    {

                    }
                ]);
        }    

        // unexpected time => 2nd output
        if (timeExpected != -1 && timeCurrent != timeExpected) {        
            node.send(
                [
                    {
                        
                    },
                    {
                        payload: lastData,
                        payloadNext: dataCurrent,
                        time: timeCurrent,
                        timeExpected: timeExpected
                    }
                ]);
         
        } 

        await sleep(10);
        
        timeExpected = timeCurrent + 1000 * 3600
        lastData = msg.payload[j]
    }

    return null;
  outputs: 2
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 240
  'y': 1320
  wires:
    - - 034a4bfbb3140f71
    - - 638b50610f0faf86
- id: 034a4bfbb3140f71
  type: function
  z: d88a69c4.1942c8
  name: Query Insert VM
  func: >-
    let url = "http://vmtest:8428/api/v1/import/prometheus" 
        + "?timestamp=" + (new Date(msg.payload.time).getTime())

    let index = parseInt(Number(msg.payload.value))

    let location = msg.payload.location

    let type = msg.payload.type.replace('-','_')


    let payload = 'sensors_' + type + '{location="' + location + '"} ' +
    Number(index)


    return {
            url: url,
            payload: payload,
            time: msg.time
        }
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 570
  'y': 1320
  wires:
    - - b7188dfa2b77d2ef
      - f269b91f7730372a
- id: 638b50610f0faf86
  type: function
  z: d88a69c4.1942c8
  name: iterate range
  func: |-
    let timeDay1 = msg.timeExpected
    let timeEnd = msg.time
    let type = msg.payload.type

    let idxSpan = msg.payloadNext.value_1h - msg.payload.value_1h
    let nbDaysSpan = parseInt((timeEnd - timeDay1) / (86400 * 1000))

    while (timeDay1 < timeEnd) {
        // day1 => day2 = 1 full day
        let timeDay2 = timeDay1 + Number(3600 * 1000)

        let index = parseInt(Number(msg.payload.value_1h))
        let indexNext = parseInt(Number(msg.payloadNext.value_1h))
        let indexFinal = index

        let time = timeDay1
        let nbDaysToEnd = parseInt((timeEnd - time) / (86400 * 1000))
        let hourOfDay = new Date(msg.time).getHours()
        
        let indexAdd = 0
        let indexPerDay = (idxSpan / nbDaysSpan)
        
        switch(type) {
            case 'teleinfo-HCHP':
                indexAdd = (indexPerDay) * (nbDaysSpan - nbDaysToEnd)
                break;

            case 'teleinfo-HCHC':
                indexAdd = (indexPerDay) * (nbDaysSpan - nbDaysToEnd)
                break;

        }    

        let payload = {
            time: time,
            value: index + indexAdd,
            location: msg.payload.location,
            type: msg.payload.type
        }  
        
        node.send(
            {
                time: time,
                timeExpected: msg.timeExpected,
                idxSpan: idxSpan,
                nbDaysSpan: nbDaysSpan,
                nbDaysToEnd: nbDaysToEnd,
                hourOfDay: hourOfDay,
                payload: payload
            });

        // increment
        timeDay1 = timeDay2
    }

    return null;
  outputs: 1
  noerr: 0
  initialize: ''
  finalize: ''
  libs: []
  x: 320
  'y': 1370
  wires:
    - - 034a4bfbb3140f71
      - e120dcdddef571ed
- id: a39d60e2d87c48f8
  type: split
  z: d88a69c4.1942c8
  name: HC/HP
  splt: ','
  spltType: str
  arraySplt: 1
  arraySpltType: len
  stream: false
  addname: ''
  x: 230
  'y': 1280
  wires:
    - - 1d29eef22cdeb1fa
- id: b7188dfa2b77d2ef
  type: http request
  z: d88a69c4.1942c8
  name: Query
  method: POST
  ret: txt
  paytoqs: ignore
  url: ''
  tls: ''
  persist: false
  proxy: ''
  insecureHTTPParser: false
  authType: ''
  senderr: false
  headers: []
  x: 740
  'y': 1320
  wires:
    - - 31014155a5dbb16d
- id: 31014155a5dbb16d
  type: debug
  z: d88a69c4.1942c8
  name: debug 17
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 910
  'y': 1320
  wires: []
- id: e120dcdddef571ed
  type: debug
  z: d88a69c4.1942c8
  name: debug 18
  active: true
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 750
  'y': 1360
  wires: []
- id: f269b91f7730372a
  type: debug
  z: d88a69c4.1942c8
  name: debug 19
  active: false
  tosidebar: true
  console: false
  tostatus: false
  complete: 'true'
  targetType: full
  statusVal: ''
  statusType: auto
  x: 750
  'y': 1280
  wires: []
